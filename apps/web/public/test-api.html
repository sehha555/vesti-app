<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¡£æ«ƒ API æ¸¬è©¦å·¥å…·</title>
  <style>
    body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; }
    h1, h2, h3, h4 { color: #333; }
    .test-section { background-color: #fff; border: 1px solid #ddd; padding: 1em; margin-bottom: 1em; border-radius: 8px; }
    .test-group { border-top: 1px solid #eee; margin-top: 1em; padding-top: 1em; }
    button { padding: 10px 15px; font-size: 14px; margin: 5px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background-color: #e9e9e9; }
    button:hover { background-color: #ddd; }
    pre { padding: 1em; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
    .success { background-color: #e8f5e9; border-left: 5px solid #4caf50; }
    .error { background-color: #ffebee; border-left: 5px solid #f44336; }
    #result { margin-top: 1em; }
    .note { font-size: 0.9em; color: #666; margin-top: 10px;}
  </style>
</head>
<body>

  <h1>è¡£æ«ƒ API æ¸¬è©¦å·¥å…·</h1>

  <div class="test-section">
    <h2>ğŸ“¸ åœ–ç‰‡ä¸Šå‚³æ¸¬è©¦</h2>
    <div>
      <h3>1. ä¸Šå‚³åœ–ç‰‡</h3>
      <p style='font-size: 12px; color: #666;'>
        ğŸ’¡ åœ–ç‰‡æœƒè‡ªå‹•å£“ç¸®è‡³ 1200x1200,å“è³ª 85%,æ¸›å°‘ä¸Šå‚³æ™‚é–“
      </p>
      <input type="file" id="uploadFile" accept="image/jpeg,image/png,image/webp">
      <button onclick='uploadImage()' id='uploadBtn'>ä¸Šå‚³åœ–ç‰‡</button>
      
      <!-- é€²åº¦æ¢ -->
      <div id='uploadProgress' style='display: none; margin-top: 10px;'>
        <div style='background: #f0f0f0; border-radius: 4px; overflow: hidden; height: 24px; position: relative;'>
          <div id='progressBar' style='background: linear-gradient(90deg, #4CAF50, #45a049); height: 100%; width: 0%; transition: width 0.3s ease;'></div>
          <div id='progressText' style='position: absolute; top: 0; left: 0; right: 0; text-align: center; line-height: 24px; color: #333; font-weight: bold; font-size: 12px;'>0%</div>
        </div>
        <div id='progressStatus' style='margin-top: 5px; font-size: 12px; color: #666;'></div>
      </div>
      
      <div id='uploadStatus' style='margin-top: 10px;'></div>
    </div>
    <div class="test-group">
      <h3>2. ä¸Šå‚³çµæœ</h3>
      <div id="uploadResult">å°šæœªä¸Šå‚³</div>
      <div id="imagePreviews" style="display: flex; gap: 20px; margin-top: 10px;">
          <div id="originalContainer" style="display:none;">
              <h4>åŸåœ–</h4>
              <img id="uploadPreview" style="max-width: 300px; border: 1px solid #ccc;">
          </div>
          <div id="removedContainer" style="display:none;">
              <h4>å»èƒŒåœ–</h4>
              <img id="removedBgPreview" style="max-width: 300px; border: 1px solid #ccc;">
          </div>
      </div>
    </div>
    <div class="test-group">
      <h3>3. ä½¿ç”¨åœ–ç‰‡æ–°å¢è¡£ç‰©</h3>
      <button id="btn-add-item-with-image">æ–°å¢è¡£ç‰© (å«ä¸Šå‚³çš„åœ–ç‰‡)</button>
      <p class="note">è«‹å…ˆæˆåŠŸä¸Šå‚³ä¸€å¼µåœ–ç‰‡ï¼Œç„¶å¾Œé»æ“Šæ­¤æŒ‰éˆ•ã€‚</p>
    </div>
  </div>

  <div class="test-section">
    <h2>æ­£å¸¸æ›´æ–°æµç¨‹ (Happy Path)</h2>
    <p>ä¾åºé»æ“ŠæŒ‰éˆ•ä¾†æ¸¬è©¦å®Œæ•´çš„å»ºç«‹ã€è®€å–ã€æ›´æ–°ã€å†è®€å–æµç¨‹ã€‚</p>
    <button id="btn-create">1. æ–°å¢æ¸¬è©¦è¡£ç‰© (POST)</button>
    <button id="btn-get-before">2. å–å¾—æ›´æ–°å‰è³‡æ–™ (GET)</button>
    <button id="btn-update">3. æ›´æ–°è¡£ç‰©åç¨± (PUT)</button>
    <button id="btn-get-after">4. å–å¾—æ›´æ–°å¾Œè³‡æ–™ (GET)</button>
    <p class="note">å°‡ä½¿ç”¨å›ºå®šçš„ UserID: 'test-user-001'ã€‚æ–°å¢çš„ç‰©å“ ID æœƒè¢«æš«å­˜ä»¥ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨ã€‚</p>
  </div>

  <div class="test-section">
    <h2>éŒ¯èª¤è™•ç†æ¸¬è©¦ (Error Cases)</h2>
    <button id="btn-update-404">æ¸¬è©¦æ›´æ–°ä¸å­˜åœ¨çš„ ID (æ‡‰å›å‚³ 404)</button>
    <button id="btn-update-400">æ¸¬è©¦ç¼ºå°‘ userId çš„è«‹æ±‚ (æ‡‰å›å‚³ 400)</button>
  </div>

  <div class="test-section">
    <h2>ğŸŒ¸ å­£ç¯€éæ¿¾æ¸¬è©¦</h2>
    <button id="btn-seed-seasons">1. æ–°å¢å„å­£ç¯€çš„æ¸¬è©¦è¡£ç‰©</button>
    <br>
    <button id="btn-filter-spring">æ¸¬è©¦æ˜¥å­£ (spring)</button>
    <button id="btn-filter-summer">æ¸¬è©¦å¤å­£ (summer)</button>
    <button id="btn-filter-fall">æ¸¬è©¦ç§‹å­£ (fall)</button>
    <button id="btn-filter-winter">æ¸¬è©¦å†¬å­£ (winter)</button>
    <br>
    <button id="btn-filter-all">æ¸¬è©¦ä¸éæ¿¾ (æ‡‰å›å‚³æ‰€æœ‰)</button>
    <button id="btn-filter-invalid">æ¸¬è©¦ç„¡æ•ˆå­£ç¯€ (æ‡‰å›å‚³ 400)</button>
  </div>

  <div class="test-section">
      <h2>ğŸ·ï¸ æ¨™ç±¤ç³»çµ±æ¸¬è©¦</h2>
      <button id="btn-tags-create">1. æ–°å¢å¸¶æœ‰æ¨™ç±¤çš„è¡£ç‰©</button>
      <button id="btn-tags-add">2. ç‚ºè¡£ç‰©æ–°å¢æ¨™ç±¤ ('é‹å‹•é¢¨')</button>
      <button id="btn-tags-remove">3. ç‚ºè¡£ç‰©ç§»é™¤æ¨™ç±¤ ('ç´„æœƒç©¿')</button>
      <button id="btn-tags-get-all">4. å–å¾—ä½¿ç”¨è€…æ‰€æœ‰æ¨™ç±¤</button>
      <br>
      <button id="btn-tags-filter-tag">5. ä¾æ¨™ç±¤éæ¿¾ ('æœ€æ„›')</button>
      <button id="btn-tags-filter-combo">6. å­£ç¯€+æ¨™ç±¤çµ„åˆéæ¿¾</button>
      <button id="btn-tags-action-invalid">7. æ¸¬è©¦ç„¡æ•ˆ Action</button>
      <p class="note">æ­¤å€å¡Šçš„æ¸¬è©¦æœƒä½¿ç”¨ç¨ç«‹çš„ Item IDã€‚</p>
  </div>

  <div class="test-section">
      <h2>ğŸ›’ è³¼è²·ç‹€æ…‹æ¸¬è©¦</h2>
      <button id="btn-purchased-seed">1. æ–°å¢å·²è³¼è²·å’Œ Wishlist è¡£ç‰©</button>
      <br>
      <button id="btn-purchased-filter-true">æŸ¥è©¢å·²è³¼è²·</button>
      <button id="btn-purchased-filter-false">æŸ¥è©¢ Wishlist</button>
      <button id="btn-purchased-combo-season">çµ„åˆæŸ¥è©¢ (æ˜¥å­£å·²è³¼è²·)</button>
      <button id="btn-purchased-combo-tag">çµ„åˆæŸ¥è©¢ (æœ‰'æœ€æ„›'æ¨™ç±¤çš„ Wishlist)</button>
  </div>

  <div class="test-section">
      <h2>ğŸ‘” æ­é…çµ„åˆæ¸¬è©¦</h2>
      <div class="test-group">
          <h4>1. æº–å‚™è¡£ç‰©</h4>
          <button id="btn-outfit-prep-1">æ–°å¢ç™½è‰²è¥¯è¡«</button>
          <button id="btn-outfit-prep-2">æ–°å¢é»‘è‰²è¥¿è£è¤²</button>
          <button id="btn-outfit-prep-3">æ–°å¢æ£•è‰²çš®é‹</button>
          <p class="note">è«‹å…ˆæ–°å¢é€™ä¸‰ä»¶è¡£ç‰©ä¾†æº–å‚™å»ºç«‹æ­é…çµ„åˆã€‚</p>
      </div>
      <div class="test-group">
          <h4>2. CRUD æ¸¬è©¦</h4>
          <button id="btn-outfit-crud-create">å»ºç«‹æ­é…</button>
          <button id="btn-outfit-crud-get-all">æŸ¥è©¢æ‰€æœ‰æ­é…</button>
          <button id="btn-outfit-crud-get-one">æŸ¥è©¢å–®ä¸€æ­é…</button>
          <button id="btn-outfit-crud-update">æ›´æ–°æ­é…</button>
          <button id="btn-outfit-crud-delete">åˆªé™¤æ­é…</button>
      </div>
      <div class="test-group">
          <h4>3. éæ¿¾æ¸¬è©¦</h4>
          <button id="btn-outfit-filter-seed">å»ºç«‹éæ¿¾ç”¨æ­é…</button>
          <button id="btn-outfit-filter-season">ä¾å­£ç¯€éæ¿¾ (spring)</button>
          <button id="btn-outfit-filter-occasion">ä¾å ´åˆéæ¿¾ (ç´„æœƒ)</button>
          <button id="btn-outfit-filter-tag">ä¾æ¨™ç±¤éæ¿¾ (æµªæ¼«)</button>
      </div>
      <div class="test-group">
          <h4>4. éŒ¯èª¤è™•ç†</h4>
          <button id="btn-outfit-error-no-items">æ¸¬è©¦ç¼ºå°‘ itemIds</button>
          <button id="btn-outfit-error-season">æ¸¬è©¦ç„¡æ•ˆ season</button>
          <button id="btn-outfit-error-rating">æ¸¬è©¦ç„¡æ•ˆ rating</button>
      </div>
  </div>

  <h2>æ¸¬è©¦çµæœ</h2>
  <pre id="result">é»æ“ŠæŒ‰éˆ•ä»¥é–‹å§‹æ¸¬è©¦...</pre>

  <script>
    /**
     * å£“ç¸®åœ–ç‰‡
     * @param {File} file - åŸå§‹åœ–ç‰‡æª”æ¡ˆ  
     * @param {number} maxWidth - æœ€å¤§å¯¬åº¦ (é è¨­ 1200)
     * @param {number} maxHeight - æœ€å¤§é«˜åº¦ (é è¨­ 1200)
     * @param {number} quality - å£“ç¸®å“è³ª 0-1 (é è¨­ 0.85)
     * @returns {Promise<File>} å£“ç¸®å¾Œçš„åœ–ç‰‡æª”æ¡ˆ
     */
    async function compressImage(file, maxWidth = 1200, maxHeight = 1200, quality = 0.85) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          
          img.onload = () => {
            let width = img.width;
            let height = img.height;
            
            if (width > height) {
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob(
              (blob) => {
                const compressedFile = new File([blob], file.name, {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                resolve(compressedFile);
              },
              'image/jpeg',
              quality
            );
          };
          
          img.onerror = () => reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—'));
        };
        
        reader.onerror = () => reject(new Error('æª”æ¡ˆè®€å–å¤±æ•—'));
      });
    }

    const resultEl = document.getElementById('result');
    const userId = 'test-user-001';
    let currentItemId = null;
    let tagTestItemId = null;
    let testItemIds = [];
    let testOutfitId = null;
    let uploadedImageUrl = null;

    // --- Helper Functions ---
    function logResult(title, data, success) {
      let content = `<h3>${title}</h3>`;
      if (data) {
        if (Array.isArray(data)) {
          content += `<p>æ‰¾åˆ° ${data.length} ä»¶é …ç›®ã€‚</p>`;
        }
        content += JSON.stringify(data, null, 2);
      }
      resultEl.innerHTML = content;
      resultEl.className = success ? 'success' : 'error';
    }

    async function apiFetch(url, options = {}) {
      try {
        const defaultHeaders = options.body instanceof FormData ? {} : { 'Content-Type': 'application/json' };
        const response = await fetch(url, {
          headers: { ...defaultHeaders, ...options.headers },
          ...options,
        });
        const data = response.status === 204 ? null : await response.json();
        if (!response.ok) {
          throw { status: response.status, data };
        }
        return data;
      } catch (err) {
        console.error('API Error:', err);
        throw err;
      }
    }

    // --- Refactored Filter Function ---
    async function getFilteredItems(title, params = {}) {
        const query = new URLSearchParams({ userId });
        if (params.season) query.set('season', params.season);
        if (params.tag) query.set('tag', params.tag);
        if (params.purchased !== undefined) query.set('purchased', params.purchased);
        
        try {
            const result = await apiFetch(`/api/wardrobe/items?${query.toString()}`);
            logResult(title, result, true);
        } catch (err) { logResult(`${title} - å¤±æ•—`, err, false); }
    }

    /**
     * æ›´æ–°é€²åº¦æ¢
     * @param {number} percent - é€²åº¦ç™¾åˆ†æ¯” 0-100
     * @param {string} status - ç‹€æ…‹æ–‡å­—
     */
    function updateProgress(percent, status) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressStatus = document.getElementById('progressStatus');
      const progressContainer = document.getElementById('uploadProgress');
      
      progressContainer.style.display = 'block';
      progressBar.style.width = percent + '%';
      progressText.textContent = Math.round(percent) + '%';
      progressStatus.textContent = status;
    }

    /**
     * éš±è—é€²åº¦æ¢
     */
    function hideProgress() {
      document.getElementById('uploadProgress').style.display = 'none';
    }

    /**
     * é‡ç½®é€²åº¦æ¢
     */
    function resetProgress() {
      updateProgress(0, 'æº–å‚™ä¸­...');
    }

    // --- Test Functions (Image Upload) ---
    async function uploadImage() {
      const fileInput = document.getElementById('uploadFile');
      const file = fileInput.files[0];
      const statusDiv = document.getElementById('uploadStatus');
      const uploadBtn = document.getElementById('uploadBtn');
      
      if (!file) {
        statusDiv.innerHTML = '<p style="color: red;">è«‹é¸æ“‡åœ–ç‰‡</p>';
        return;
      }
      
      try {
        // ç¦ç”¨æŒ‰éˆ•
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'è™•ç†ä¸­...';
        
        // é‡ç½®ä¸¦é¡¯ç¤ºé€²åº¦æ¢
        resetProgress();
        statusDiv.innerHTML = '';
        
        // é¡¯ç¤ºåŸå§‹æª”æ¡ˆè³‡è¨Š
        const originalSize = (file.size / 1024).toFixed(2);
        console.log('ğŸ“ åŸå§‹æª”æ¡ˆ:', file.name, originalSize + 'KB');
        
        // === éšæ®µ 1: å£“ç¸® ===
        updateProgress(10, 'ğŸ”„ æ­£åœ¨å£“ç¸®åœ–ç‰‡...');
        
        const compressedFile = await compressImage(file, 1200, 1200, 0.85);
        
        const compressedSize = (compressedFile.size / 1024).toFixed(2);
        const reduction = ((1 - compressedFile.size / file.size) * 100).toFixed(1);
        
        console.log('âœ“ å£“ç¸®å®Œæˆ:', compressedFile.name, compressedSize + 'KB', 'æ¸›å°‘ ' + reduction + '%');
        
        updateProgress(30, 'âœ“ å£“ç¸®å®Œæˆ (' + originalSize + 'KB â†’ ' + compressedSize + 'KB)');
        
        // å»¶é²ä¸€ä¸‹è®“ä½¿ç”¨è€…çœ‹åˆ°å£“ç¸®å®Œæˆ
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // === éšæ®µ 2: ä¸Šå‚³ ===
        updateProgress(40, 'â¬†ï¸ é–‹å§‹ä¸Šå‚³...');
        
        const formData = new FormData();
        formData.append('file', compressedFile);
        
        const uploadStartTime = Date.now();
        
        // ä½¿ç”¨ XMLHttpRequest ä»¥æ”¯æ´é€²åº¦äº‹ä»¶
        const result = await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          
          // ä¸Šå‚³é€²åº¦äº‹ä»¶
          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const uploadPercent = (e.loaded / e.total) * 100;
              // é€²åº¦ç¯„åœ: 40% - 90%
              const totalPercent = 40 + (uploadPercent * 0.5);
              updateProgress(totalPercent, 'â¬†ï¸ ä¸Šå‚³ä¸­... ' + uploadPercent.toFixed(0) + '%');
            }
          });
          
          // å®Œæˆäº‹ä»¶
          xhr.addEventListener('load', () => {
            if (xhr.status === 200) {
              resolve(JSON.parse(xhr.responseText));
            } else {
              reject(new Error(JSON.parse(xhr.responseText).error || 'ä¸Šå‚³å¤±æ•—'));
            }
          });
          
          // éŒ¯èª¤äº‹ä»¶
          xhr.addEventListener('error', () => reject(new Error('ç¶²è·¯éŒ¯èª¤')));
          xhr.addEventListener('abort', () => reject(new Error('ä¸Šå‚³å·²å–æ¶ˆ')));
          
          // ç™¼é€è«‹æ±‚
          xhr.open('POST', '/api/upload');
          xhr.send(formData);
        });
        
        // === éšæ®µ 3: å®Œæˆ ===
        updateProgress(100, 'âœ“ ä¸Šå‚³æˆåŠŸ!');
        
        const data = result;
        console.log('âœ… API Response:', data);

        // å„²å­˜ URL
        uploadedImageUrl = data.originalUrl;

        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        let successMessage = '<p style="color: green; font-weight: bold;">âœ“ ä¸Šå‚³æˆåŠŸ!</p>' +
          '<p style="font-size: 12px;">å£“ç¸®: ' + originalSize + 'KB â†’ ' + compressedSize + 'KB (æ¸›å°‘ ' + reduction + '%)</p>' +
          '<p style="font-size: 12px;">ç¸½è™•ç†æ™‚é–“: ' + data.processingTime.toFixed(2) + ' ç§’</p>';
        if (data.backgroundRemoved === false && data.error) {
            successMessage += '<p style="color: #d8a044; font-weight: bold;">' + data.error + '</p>';
        }
        statusDiv.innerHTML = successMessage;

        // é¡¯ç¤ºçµæœ
        document.getElementById('uploadResult').innerHTML =
          '<pre style="font-size: 11px;">' + JSON.stringify(data, null, 2) + '</pre>';

        // é¡¯ç¤ºé è¦½
        const originalContainer = document.getElementById('originalContainer');
        const removedContainer = document.getElementById('removedContainer');
        const uploadPreview = document.getElementById('uploadPreview');
        const removedBgPreview = document.getElementById('removedBgPreview');

        // Reset
        originalContainer.style.display = 'none';
        removedContainer.style.display = 'none';

        if (data.success && data.originalUrl) {
            uploadPreview.src = data.originalUrl;
            originalContainer.style.display = 'block';

            if (data.backgroundRemoved && data.removedBgUrl) {
                removedBgPreview.src = data.removedBgUrl;
                removedContainer.style.display = 'block';
            } else {
                console.log('å»èƒŒåœ–ä¸å­˜åœ¨æˆ–å»èƒŒå¤±æ•—');
            }
        } else {
            console.error('ä¸Šå‚³æˆåŠŸï¼Œä½†å›å‚³çš„è³‡æ–™æ ¼å¼ä¸ç¬¦é æœŸ', data);
        }
        
        // 2 ç§’å¾Œéš±è—é€²åº¦æ¢
        setTimeout(() => {
          hideProgress();
        }, 2000);
        
      } catch (error) {
        console.error('âŒ ä¸Šå‚³éŒ¯èª¤:', error);
        updateProgress(0, '');
        hideProgress();
        statusDiv.innerHTML = '<p style="color: red;">âœ— ä¸Šå‚³å¤±æ•—: ' + error.message + '</p>';
      } finally {
        // æ¢å¾©æŒ‰éˆ•
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'ä¸Šå‚³åœ–ç‰‡';
      }
    }

    async function addItemWithImage() {
        if (!uploadedImageUrl) {
            logResult('æ–°å¢è¡£ç‰©å¤±æ•—', { error: 'è«‹å…ˆæˆåŠŸä¸Šå‚³ä¸€å¼µåœ–ç‰‡' }, false);
            return;
        }
        const dto = { userId, name: 'è¡£ç‰© (å«åœ–)', type: 'top', season: 'all-season', imageUrl: uploadedImageUrl, purchased: true, colors:['multi'] };
        try {
            const result = await apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(dto) });
            logResult('ä½¿ç”¨ä¸Šå‚³çš„åœ–ç‰‡æ–°å¢è¡£ç‰©æˆåŠŸ', result, true);
        } catch (err) {
            logResult('ä½¿ç”¨ä¸Šå‚³çš„åœ–ç‰‡æ–°å¢è¡£ç‰©å¤±æ•—', err, false);
        }
    }

    // --- Test Functions (Original) ---
    async function createItem() {
      try {
        const newItemDto = { userId, name: 'å¾©å¤ç‰›ä»”å¤¾å…‹', type: 'outerwear', imageUrl: 'http://example.com/image.jpg', colors: ['blue'], season: 'all-season', purchased: true };
        const result = await apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(newItemDto) });
        currentItemId = result.id;
        logResult('1. æ–°å¢è¡£ç‰©æˆåŠŸ', { ...result, note: `å·²å„²å­˜ ID: ${currentItemId}` }, true);
      } catch (err) { logResult('1. æ–°å¢è¡£ç‰©å¤±æ•—', err, false); }
    }
    async function getItem(id, step) {
      if (!id) { logResult(`${step}. å–å¾—è³‡æ–™å¤±æ•—`, { error: "å°šæœªå»ºç«‹è¡£ç‰©" }, false); return; }
      try {
        const result = await apiFetch(`/api/wardrobe/items/${id}`);
        logResult(`${step}. å–å¾—è³‡æ–™æˆåŠŸ`, result, true);
        return result;
      } catch (err) { logResult(`${step}. å–å¾—è³‡æ–™å¤±æ•—`, err, false); }
    }
    async function updateItem() {
      if (!currentItemId) { logResult('3. æ›´æ–°å¤±æ•—', { error: "å°šæœªå»ºç«‹è¡£ç‰©" }, false); return; }
      try {
        const updateDto = { userId, name: 'æ‘©ç™»çš®å¤¾å…‹ (å·²æ›´æ–°)', colors: ['black'] };
        const result = await apiFetch(`/api/wardrobe/items/${currentItemId}`, { method: 'PUT', body: JSON.stringify(updateDto) });
        logResult('3. æ›´æ–°æˆåŠŸ', result, true);
      } catch (err) { logResult('3. æ›´æ–°å¤±æ•—', err, false); }
    }
    async function test404() {
      try { await apiFetch('/api/wardrobe/items/non-existent-id-12345', { method: 'PUT', body: JSON.stringify({ userId, name: 'test' }) }); } catch (err) {
        if (err.status === 404) { logResult('404 æ¸¬è©¦æˆåŠŸ', err, true); } else { logResult('404 æ¸¬è©¦å¤±æ•—', err, false); }
      }
    }
    async function test400() {
        if (!currentItemId) { logResult('400 æ¸¬è©¦å¤±æ•—', { error: "å°šæœªå»ºç«‹è¡£ç‰©" }, false); return; }
        try { await apiFetch(`/api/wardrobe/items/${currentItemId}`, { method: 'PUT', body: JSON.stringify({ name: 'a new name without userId' }) }); } catch (err) {
            if (err.status === 400) { logResult('400 æ¸¬è©¦æˆåŠŸ', err, true); } else { logResult('400 æ¸¬è©¦å¤±æ•—', err, false); }
        }
    }

    // --- Test Functions (Season Filtering) ---
    async function seedSeasonItems() {
        const itemsToCreate = [ { name: 'æ˜¥å­£è–„è¡«', season: 'spring', type: 'top' }, { name: 'å¤å­£çŸ­è¤²', season: 'summer', type: 'bottom' }, { name: 'ç§‹å­£é¢¨è¡£', season: 'fall', type: 'outerwear' }, { name: 'å†¬å­£æ¯›è¡£', season: 'winter', type: 'top' } ];
        try {
            const promises = itemsToCreate.map(item => apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify({ ...item, userId, imageUrl: 'img.jpg', colors:['red'], purchased: false }) }));
            const results = await Promise.all(promises);
            logResult('å­£ç¯€è¡£ç‰©æ–°å¢æˆåŠŸ', results, true);
        } catch (err) { logResult('å­£ç¯€è¡£ç‰©æ–°å¢å¤±æ•—', err, false); }
    }
    async function testInvalidSeason() {
        const title = 'æ¸¬è©¦ç„¡æ•ˆå­£ç¯€åƒæ•¸';
        try { await apiFetch(`/api/wardrobe/items?userId=${userId}&season=invalidseason`); } catch (err) {
            if (err.status === 400) { logResult(title + ' (æˆåŠŸæ””æˆªéŒ¯èª¤)', err, true); } else { logResult(title + ' (æœªæ””æˆªåˆ°é æœŸéŒ¯èª¤)', err, false); }
        }
    }

    // --- Test Functions (Tag System) ---
    async function createItemWithTags() {
        try {
            const newItemDto = { userId, name: 'ç™½è‰²è¥¯è¡«', type: 'top', season: 'spring', tags: ['ç´„æœƒç©¿', 'æœ€æ„›'], imageUrl: 'img.jpg', colors:['white'], purchased: true };
            const result = await apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(newItemDto) });
            tagTestItemId = result.id;
            logResult('1. æ–°å¢å¸¶æ¨™ç±¤è¡£ç‰©æˆåŠŸ', { ...result, note: `å·²å„²å­˜ ID: ${tagTestItemId}` }, true);
        } catch (err) { logResult('1. æ–°å¢å¸¶æ¨™ç±¤è¡£ç‰©å¤±æ•—', err, false); }
    }
    async function addTag() {
        if (!tagTestItemId) { logResult('æ–°å¢æ¨™ç±¤å¤±æ•—', { error: "å°šæœªå»ºç«‹æ¨™ç±¤æ¸¬è©¦è¡£ç‰©" }, false); return; }
        try {
            const result = await apiFetch('/api/wardrobe/tags', { method: 'POST', body: JSON.stringify({ userId, itemId: tagTestItemId, tag: 'é‹å‹•é¢¨', action: 'add' }) });
            logResult('2. æ–°å¢æ¨™ç±¤æˆåŠŸ', result, true);
        } catch (err) { logResult('2. æ–°å¢æ¨™ç±¤å¤±æ•—', err, false); }
    }
    async function removeTag() {
        if (!tagTestItemId) { logResult('ç§»é™¤æ¨™ç±¤å¤±æ•—', { error: "å°šæœªå»ºç«‹æ¨™ç±¤æ¸¬è©¦è¡£ç‰©" }, false); return; }
        try {
            const result = await apiFetch('/api/wardrobe/tags', { method: 'POST', body: JSON.stringify({ userId, itemId: tagTestItemId, tag: 'ç´„æœƒç©¿', action: 'remove' }) });
            logResult('3. ç§»é™¤æ¨™ç±¤æˆåŠŸ', result, true);
        } catch (err) { logResult('3. ç§»é™¤æ¨™ç±¤å¤±æ•—', err, false); }
    }
    async function getAllUserTags() {
        try {
            const result = await apiFetch(`/api/wardrobe/tags?userId=${userId}`);
            logResult('4. å–å¾—æ‰€æœ‰æ¨™ç±¤æˆåŠŸ', result, true);
        } catch (err) { logResult('4. å–å¾—æ‰€æœ‰æ¨™ç±¤å¤±æ•—', err, false); }
    }
    async function testInvalidAction() {
        if (!tagTestItemId) { logResult('ç„¡æ•ˆ Action æ¸¬è©¦å¤±æ•—', { error: "å°šæœªå»ºç«‹æ¨™ç±¤æ¸¬è©¦è¡£ç‰©" }, false); return; }
        const title = '7. æ¸¬è©¦ç„¡æ•ˆ Action';
        try { await apiFetch('/api/wardrobe/tags', { method: 'POST', body: JSON.stringify({ userId, itemId: tagTestItemId, tag: 'test', action: 'delete' }) }); } catch (err) {
            if (err.status === 400) { logResult(title + ' (æˆåŠŸæ””æˆªéŒ¯èª¤)', err, true); } else { logResult(title + ' (æœªæ””æˆªåˆ°é æœŸéŒ¯èª¤)', err, false); }
        }
    }

    // --- Test Functions (Purchase Status) ---
    async function seedPurchaseStatusItems() {
        const purchasedItem = { userId, name: 'é»‘è‰²è¥¿è£å¤–å¥—', type: 'top', season: 'spring', purchased: true, imageUrl: 'img.jpg', colors:['black'] };
        const wishlistItem = { userId, name: 'å¤¢æƒ³ä¸­çš„çš®è¡£', type: 'outerwear', season: 'fall', purchased: false, tags: ['æœ€æ„›'], imageUrl: 'img.jpg', colors:['brown'] };
        try {
            const results = await Promise.all([ apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(purchasedItem) }), apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(wishlistItem) }) ]);
            logResult('è³¼è²·ç‹€æ…‹è¡£ç‰©æ–°å¢æˆåŠŸ', results, true);
        } catch (err) { logResult('è³¼è²·ç‹€æ…‹è¡£ç‰©æ–°å¢å¤±æ•—', err, false); }
    }

    // --- Test Functions (Outfit) ---
    async function createTestWardrobeItem(dto, title) {
        try {
            const result = await apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify({ ...dto, userId, imageUrl: 'img.jpg', colors:['default'], purchased: true }) });
            testItemIds.push(result.id);
            logResult(title, { ...result, note: `å·²å„²å­˜è¡£ç‰© ID: ${result.id}ã€‚ç›®å‰è¡£ç‰©æ•¸: ${testItemIds.length}` }, true);
        } catch (err) { logResult(title, err, false); }
    }
    async function createTestOutfit() {
        if (testItemIds.length < 3) { logResult('å»ºç«‹æ­é…å¤±æ•—', { error: "è«‹å…ˆæ–°å¢ 3 ä»¶æº–å‚™è¡£ç‰©" }, false); return; }
        try {
            const dto = { userId, name: 'å•†å‹™æœƒè­°ç©¿æ­', description: 'æ­£å¼å ´åˆå°ˆç”¨', itemIds: testItemIds, occasion: 'ä¸Šç­', tags: ['æ­£å¼', 'å•†å‹™'] };
            const result = await apiFetch('/api/outfits', { method: 'POST', body: JSON.stringify(dto) });
            testOutfitId = result.id;
            logResult('å»ºç«‹æ­é…æˆåŠŸ', { ...result, note: `å·²å„²å­˜æ­é… ID: ${testOutfitId}` }, true);
        } catch (err) { logResult('å»ºç«‹æ­é…å¤±æ•—', err, false); }
    }
    async function getAllTestOutfits() {
        try {
            const result = await apiFetch(`/api/outfits?userId=${userId}`);
            logResult('æŸ¥è©¢æ‰€æœ‰æ­é…æˆåŠŸ', result, true);
        } catch (err) { logResult('æŸ¥è©¢æ‰€æœ‰æ­é…å¤±æ•—', err, false); }
    }
    async function getSingleTestOutfit() {
        if (!testOutfitId) { logResult('æŸ¥è©¢å–®ä¸€æ­é…å¤±æ•—', { error: "å°šæœªå»ºç«‹æ­é…" }, false); return; }
        try {
            const result = await apiFetch(`/api/outfits/${testOutfitId}?userId=${userId}`);
            logResult('æŸ¥è©¢å–®ä¸€æ­é…æˆåŠŸ', result, true);
        } catch (err) { logResult('æŸ¥è©¢å–®ä¸€æ­é…å¤±æ•—', err, false); }
    }
    async function updateTestOutfit() {
        if (!testOutfitId) { logResult('æ›´æ–°æ­é…å¤±æ•—', { error: "å°šæœªå»ºç«‹æ­é…" }, false); return; }
        try {
            const updates = { userId, name: 'å•†å‹™æœƒè­°ç©¿æ­ (æ›´æ–°ç‰ˆ)', tags: ['æ­£å¼', 'å•†å‹™', 'é‡è¦æœƒè­°'], rating: 5 };
            const result = await apiFetch(`/api/outfits/${testOutfitId}`, { method: 'PUT', body: JSON.stringify(updates) });
            logResult('æ›´æ–°æ­é…æˆåŠŸ', result, true);
        } catch (err) { logResult('æ›´æ–°æ­é…å¤±æ•—', err, false); }
    }
    async function deleteTestOutfit() {
        if (!testOutfitId) { logResult('åˆªé™¤æ­é…å¤±æ•—', { error: "å°šæœªå»ºç«‹æ­é…" }, false); return; }
        try {
            const result = await apiFetch(`/api/outfits/${testOutfitId}?userId=${userId}`, { method: 'DELETE' });
            logResult('åˆªé™¤æ­é…æˆåŠŸ', result, true);
            testOutfitId = null; // Clear the ID after deletion
        } catch (err) { logResult('åˆªé™¤æ­é…å¤±æ•—', err, false); }
    }
    async function createFilterTestData() {
        const outfit1 = { userId, name: 'æ˜¥å­£ç´„æœƒæ­é…', itemIds: [testItemIds[0] || 'item1'], season: 'spring', occasion: 'ç´„æœƒ', tags: ['æµªæ¼«'] };
        const outfit2 = { userId, name: 'å¤å­£é‹å‹•æ­é…', itemIds: [testItemIds[1] || 'item2'], season: 'summer', occasion: 'é‹å‹•', tags: ['ä¼‘é–’'] };
        try {
            const results = await Promise.all([
                apiFetch('/api/outfits', { method: 'POST', body: JSON.stringify(outfit1) }),
                apiFetch('/api/outfits', { method: 'POST', body: JSON.stringify(outfit2) })
            ]);
            logResult('å»ºç«‹éæ¿¾ç”¨æ­é…æˆåŠŸ', results, true);
        } catch (err) { logResult('å»ºç«‹éæ¿¾ç”¨æ­é…å¤±æ•—', err, false); }
    }
    async function getFilteredOutfits(title, params = {}) {
        const query = new URLSearchParams({ userId });
        if (params.season) query.set('season', params.season);
        if (params.tag) query.set('tag', params.tag);
        if (params.occasion) query.set('occasion', params.occasion);
        try {
            const result = await apiFetch(`/api/outfits?${query.toString()}`);
            logResult(title, result, true);
        } catch (err) { logResult(`${title} - å¤±æ•—`, err, false); }
    }
    async function testOutfitError(title, dto) {
        try {
            await apiFetch('/api/outfits', { method: 'POST', body: JSON.stringify({ userId, name: 'éŒ¯èª¤æ¸¬è©¦', ...dto }) });
        } catch (err) {
            if (err.status === 400) { logResult(title + ' (æˆåŠŸæ””æˆªéŒ¯èª¤)', err, true); } else { logResult(title + ' (æœªæ””æˆªåˆ°é æœŸéŒ¯èª¤)', err, false); }
        }
    }

    // --- Event Listeners ---
    document.getElementById('btn-create').addEventListener('click', createItem);
    document.getElementById('btn-get-before').addEventListener('click', () => getItem(currentItemId, '2. æ›´æ–°å‰'));
    document.getElementById('btn-update').addEventListener('click', updateItem);
    document.getElementById('btn-get-after').addEventListener('click', () => getItem(currentItemId, '4. æ›´æ–°å¾Œ'));
    document.getElementById('btn-update-404').addEventListener('click', test404);
    document.getElementById('btn-update-400').addEventListener('click', test400);

    // Season filtering listeners
    document.getElementById('btn-seed-seasons').addEventListener('click', seedSeasonItems);
    document.getElementById('btn-filter-spring').addEventListener('click', () => getFilteredItems('æŸ¥è©¢æ˜¥å­£è¡£ç‰©', { season: 'spring' }));
    document.getElementById('btn-filter-summer').addEventListener('click', () => getFilteredItems('æŸ¥è©¢å¤å­£è¡£ç‰©', { season: 'summer' }));
    document.getElementById('btn-filter-fall').addEventListener('click', () => getFilteredItems('æŸ¥è©¢ç§‹å­£è¡£ç‰©', { season: 'fall' }));
    document.getElementById('btn-filter-winter').addEventListener('click', () => getFilteredItems('æŸ¥è©¢å†¬å­£è¡£ç‰©', { season: 'winter' }));
    document.getElementById('btn-filter-all').addEventListener('click', () => getFilteredItems('æŸ¥è©¢æ‰€æœ‰è¡£ç‰©', {}));
    document.getElementById('btn-filter-invalid').addEventListener('click', testInvalidSeason);

    // Tag system listeners
    document.getElementById('btn-tags-create').addEventListener('click', createItemWithTags);
    document.getElementById('btn-tags-add').addEventListener('click', addTag);
    document.getElementById('btn-tags-remove').addEventListener('click', removeTag);
    document.getElementById('btn-tags-get-all').addEventListener('click', getAllUserTags);
    document.getElementById('btn-tags-filter-tag').addEventListener('click', () => getFilteredItems('5. ä¾æ¨™ç±¤éæ¿¾', { tag: 'æœ€æ„›' }));
    document.getElementById('btn-tags-filter-combo').addEventListener('click', () => getFilteredItems('6. å­£ç¯€+æ¨™ç±¤çµ„åˆéæ¿¾', { season: 'spring', tag: 'æœ€æ„›' }));
    document.getElementById('btn-tags-action-invalid').addEventListener('click', testInvalidAction);

    // Purchase status listeners
    document.getElementById('btn-purchased-seed').addEventListener('click', seedPurchaseStatusItems);
    document.getElementById('btn-purchased-filter-true').addEventListener('click', () => getFilteredItems('æŸ¥è©¢å·²è³¼è²·', { purchased: 'true' }));
    document.getElementById('btn-purchased-filter-false').addEventListener('click', () => getFilteredItems('æŸ¥è©¢ Wishlist', { purchased: 'false' }));
    document.getElementById('btn-purchased-combo-season').addEventListener('click', () => getFilteredItems('çµ„åˆæŸ¥è©¢ (æ˜¥å­£å·²è³¼è²·)', { season: 'spring', purchased: 'true' }));
    document.getElementById('btn-purchased-combo-tag').addEventListener('click', () => getFilteredItems('çµ„åˆæŸ¥è©¢ (æœ‰\'æœ€æ„›\'æ¨™ç±¤çš„ Wishlist)', { tag: 'æœ€æ„›', purchased: 'false' }));

    // Outfit listeners
    document.getElementById('btn-outfit-prep-1').addEventListener('click', () => createTestWardrobeItem({ name: 'ç™½è‰²è¥¯è¡«', type: 'top', season: 'all-season' }, 'æ–°å¢ç™½è‰²è¥¯è¡«'));
    document.getElementById('btn-outfit-prep-2').addEventListener('click', () => createTestWardrobeItem({ name: 'é»‘è‰²è¥¿è£è¤²', type: 'bottom', season: 'all-season' }, 'æ–°å¢é»‘è‰²è¥¿è£è¤²'));
    document.getElementById('btn-outfit-prep-3').addEventListener('click', () => createTestWardrobeItem({ name: 'æ£•è‰²çš®é‹', type: 'shoes', season: 'all-season' }, 'æ–°å¢æ£•è‰²çš®é‹'));
    document.getElementById('btn-outfit-crud-create').addEventListener('click', createTestOutfit);
    document.getElementById('btn-outfit-crud-get-all').addEventListener('click', getAllTestOutfits);
    document.getElementById('btn-outfit-crud-get-one').addEventListener('click', getSingleTestOutfit);
    document.getElementById('btn-outfit-crud-update').addEventListener('click', updateTestOutfit);
    document.getElementById('btn-outfit-crud-delete').addEventListener('click', deleteTestOutfit);
    document.getElementById('btn-outfit-filter-seed').addEventListener('click', createFilterTestData);
    document.getElementById('btn-outfit-filter-season').addEventListener('click', () => getFilteredOutfits('ä¾å­£ç¯€éæ¿¾ (spring)', { season: 'spring' }));
    document.getElementById('btn-outfit-filter-occasion').addEventListener('click', () => getFilteredOutfits('ä¾å ´åˆéæ¿¾ (ç´„æœƒ)', { occasion: 'ç´„æœƒ' }));
    document.getElementById('btn-outfit-filter-tag').addEventListener('click', () => getFilteredOutfits('ä¾æ¨™ç±¤éæ¿¾ (æµªæ¼«)', { tag: 'æµªæ¼«' }));
    document.getElementById('btn-outfit-error-no-items').addEventListener('click', () => testOutfitError('æ¸¬è©¦ç¼ºå°‘ itemIds', { itemIds: [] }));
    document.getElementById('btn-outfit-error-season').addEventListener('click', () => testOutfitError('æ¸¬è©¦ç„¡æ•ˆ season', { itemIds: ['item1'], season: 'rainy' }));
    document.getElementById('btn-outfit-error-rating').addEventListener('click', () => testOutfitError('æ¸¬è©¦ç„¡æ•ˆ rating', { itemIds: ['item1'], rating: 99 }));

    // Image Upload Listeners
    
    document.getElementById('btn-add-item-with-image').addEventListener('click', addItemWithImage);

  </script>
</body>
</html>