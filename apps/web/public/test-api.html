<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¡£æ«ƒ API æ¸¬è©¦å·¥å…·</title>
  <style>
    body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; }
    h1, h2 { color: #333; }
    .test-section { background-color: #fff; border: 1px solid #ddd; padding: 1em; margin-bottom: 1em; border-radius: 8px; }
    button { padding: 10px 15px; font-size: 14px; margin: 5px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background-color: #e9e9e9; }
    button:hover { background-color: #ddd; }
    pre { padding: 1em; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
    .success { background-color: #e8f5e9; border-left: 5px solid #4caf50; }
    .error { background-color: #ffebee; border-left: 5px solid #f44336; }
    #result { margin-top: 1em; }
    .note { font-size: 0.9em; color: #666; margin-top: 10px;}
  </style>
</head>
<body>

  <h1>è¡£æ«ƒ API æ¸¬è©¦å·¥å…·</h1>

  <div class="test-section">
    <h2>æ­£å¸¸æ›´æ–°æµç¨‹ (Happy Path)</h2>
    <p>ä¾åºé»æ“ŠæŒ‰éˆ•ä¾†æ¸¬è©¦å®Œæ•´çš„å»ºç«‹ã€è®€å–ã€æ›´æ–°ã€å†è®€å–æµç¨‹ã€‚</p>
    <button id="btn-create">1. æ–°å¢æ¸¬è©¦è¡£ç‰© (POST)</button>
    <button id="btn-get-before">2. å–å¾—æ›´æ–°å‰è³‡æ–™ (GET)</button>
    <button id="btn-update">3. æ›´æ–°è¡£ç‰©åç¨± (PUT)</button>
    <button id="btn-get-after">4. å–å¾—æ›´æ–°å¾Œè³‡æ–™ (GET)</button>
    <p class="note">å°‡ä½¿ç”¨å›ºå®šçš„ UserID: 'test-user-001'ã€‚æ–°å¢çš„ç‰©å“ ID æœƒè¢«æš«å­˜ä»¥ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨ã€‚</p>
  </div>

  <div class="test-section">
    <h2>éŒ¯èª¤è™•ç†æ¸¬è©¦ (Error Cases)</h2>
    <button id="btn-update-404">æ¸¬è©¦æ›´æ–°ä¸å­˜åœ¨çš„ ID (æ‡‰å›å‚³ 404)</button>
    <button id="btn-update-400">æ¸¬è©¦ç¼ºå°‘ userId çš„è«‹æ±‚ (æ‡‰å›å‚³ 400)</button>
  </div>

  <div class="test-section">
    <h2>ğŸŒ¸ å­£ç¯€éæ¿¾æ¸¬è©¦</h2>
    <button id="btn-seed-seasons">1. æ–°å¢å„å­£ç¯€çš„æ¸¬è©¦è¡£ç‰©</button>
    <br>
    <button id="btn-filter-spring">æ¸¬è©¦æ˜¥å­£ (spring)</button>
    <button id="btn-filter-summer">æ¸¬è©¦å¤å­£ (summer)</button>
    <button id="btn-filter-fall">æ¸¬è©¦ç§‹å­£ (fall)</button>
    <button id="btn-filter-winter">æ¸¬è©¦å†¬å­£ (winter)</button>
    <br>
    <button id="btn-filter-all">æ¸¬è©¦ä¸éæ¿¾ (æ‡‰å›å‚³æ‰€æœ‰)</button>
    <button id="btn-filter-invalid">æ¸¬è©¦ç„¡æ•ˆå­£ç¯€ (æ‡‰å›å‚³ 400)</button>
  </div>

  <div class="test-section">
      <h2>ğŸ·ï¸ æ¨™ç±¤ç³»çµ±æ¸¬è©¦</h2>
      <button id="btn-tags-create">1. æ–°å¢å¸¶æœ‰æ¨™ç±¤çš„è¡£ç‰©</button>
      <button id="btn-tags-add">2. ç‚ºè¡£ç‰©æ–°å¢æ¨™ç±¤ ('é‹å‹•é¢¨')</button>
      <button id="btn-tags-remove">3. ç‚ºè¡£ç‰©ç§»é™¤æ¨™ç±¤ ('ç´„æœƒç©¿')</button>
      <button id="btn-tags-get-all">4. å–å¾—ä½¿ç”¨è€…æ‰€æœ‰æ¨™ç±¤</button>
      <br>
      <button id="btn-tags-filter-tag">5. ä¾æ¨™ç±¤éæ¿¾ ('æœ€æ„›')</button>
      <button id="btn-tags-filter-combo">6. å­£ç¯€+æ¨™ç±¤çµ„åˆéæ¿¾</button>
      <button id="btn-tags-action-invalid">7. æ¸¬è©¦ç„¡æ•ˆ Action</button>
      <p class="note">æ­¤å€å¡Šçš„æ¸¬è©¦æœƒä½¿ç”¨ç¨ç«‹çš„ Item IDã€‚</p>
  </div>

  <h2>æ¸¬è©¦çµæœ</h2>
  <pre id="result">é»æ“ŠæŒ‰éˆ•ä»¥é–‹å§‹æ¸¬è©¦...</pre>

  <script>
    const resultEl = document.getElementById('result');
    const userId = 'test-user-001';
    let currentItemId = null;
    let tagTestItemId = null; // Separate item ID for tag tests

    // --- Helper Functions ---
    function logResult(title, data, success) {
      let content = `<h3>${title}</h3>`;
      if (data) {
        if (Array.isArray(data)) {
          content += `<p>æ‰¾åˆ° ${data.length} ä»¶é …ç›®ã€‚</p>`;
        }
        content += JSON.stringify(data, null, 2);
      }
      resultEl.innerHTML = content;
      resultEl.className = success ? 'success' : 'error';
    }

    async function apiFetch(url, options = {}) {
      try {
        const response = await fetch(url, {
          headers: { 'Content-Type': 'application/json' },
          ...options,
        });
        const data = response.status === 204 ? null : await response.json();
        if (!response.ok) {
          throw { status: response.status, data };
        }
        return data;
      } catch (err) {
        console.error('API Error:', err);
        throw err;
      }
    }

    // --- Test Functions (Original) ---
    async function createItem() {
      try {
        const newItemDto = { userId, name: 'å¾©å¤ç‰›ä»”å¤¾å…‹', type: 'outerwear', imageUrl: 'http://example.com/image.jpg', colors: ['blue'], season: 'all-season', purchased: true };
        const result = await apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(newItemDto) });
        currentItemId = result.id;
        logResult('1. æ–°å¢è¡£ç‰©æˆåŠŸ', { ...result, note: `å·²å„²å­˜ ID: ${currentItemId}` }, true);
      } catch (err) { logResult('1. æ–°å¢è¡£ç‰©å¤±æ•—', err, false); }
    }
    async function getItem(id, step) {
      if (!id) { logResult(`${step}. å–å¾—è³‡æ–™å¤±æ•—`, { error: "å°šæœªå»ºç«‹è¡£ç‰©" }, false); return; }
      try {
        const result = await apiFetch(`/api/wardrobe/items/${id}`);
        logResult(`${step}. å–å¾—è³‡æ–™æˆåŠŸ`, result, true);
        return result;
      } catch (err) { logResult(`${step}. å–å¾—è³‡æ–™å¤±æ•—`, err, false); }
    }
    async function updateItem() {
      if (!currentItemId) { logResult('3. æ›´æ–°å¤±æ•—', { error: "å°šæœªå»ºç«‹è¡£ç‰©" }, false); return; }
      try {
        const updateDto = { userId, name: 'æ‘©ç™»çš®å¤¾å…‹ (å·²æ›´æ–°)', colors: ['black'] };
        const result = await apiFetch(`/api/wardrobe/items/${currentItemId}`, { method: 'PUT', body: JSON.stringify(updateDto) });
        logResult('3. æ›´æ–°æˆåŠŸ', result, true);
      } catch (err) { logResult('3. æ›´æ–°å¤±æ•—', err, false); }
    }
    async function test404() {
      try { await apiFetch('/api/wardrobe/items/non-existent-id-12345', { method: 'PUT', body: JSON.stringify({ userId, name: 'test' }) }); } catch (err) {
        if (err.status === 404) { logResult('404 æ¸¬è©¦æˆåŠŸ', err, true); } else { logResult('404 æ¸¬è©¦å¤±æ•—', err, false); }
      }
    }
    async function test400() {
        if (!currentItemId) { logResult('400 æ¸¬è©¦å¤±æ•—', { error: "å°šæœªå»ºç«‹è¡£ç‰©" }, false); return; }
        try { await apiFetch(`/api/wardrobe/items/${currentItemId}`, { method: 'PUT', body: JSON.stringify({ name: 'a new name without userId' }) }); } catch (err) {
            if (err.status === 400) { logResult('400 æ¸¬è©¦æˆåŠŸ', err, true); } else { logResult('400 æ¸¬è©¦å¤±æ•—', err, false); }
        }
    }

    // --- Test Functions (Season Filtering) ---
    async function seedSeasonItems() {
        const itemsToCreate = [ { name: 'æ˜¥å­£è–„è¡«', season: 'spring', type: 'top' }, { name: 'å¤å­£çŸ­è¤²', season: 'summer', type: 'bottom' }, { name: 'ç§‹å­£é¢¨è¡£', season: 'fall', type: 'outerwear' }, { name: 'å†¬å­£æ¯›è¡£', season: 'winter', type: 'top' } ];
        try {
            const promises = itemsToCreate.map(item => apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify({ ...item, userId, imageUrl: 'img.jpg', colors:['red'], purchased: false }) }));
            const results = await Promise.all(promises);
            logResult('å­£ç¯€è¡£ç‰©æ–°å¢æˆåŠŸ', results, true);
        } catch (err) { logResult('å­£ç¯€è¡£ç‰©æ–°å¢å¤±æ•—', err, false); }
    }
    async function getFilteredItems(season, title, tag) {
        let url = `/api/wardrobe/items?userId=${userId}`;
        if (season) { url += `&season=${season}`; }
        if (tag) { url += `&tag=${tag}`; }
        try {
            const result = await apiFetch(url);
            logResult(title, result, true);
        } catch (err) { logResult(`${title} - å¤±æ•—`, err, false); }
    }
    async function testInvalidSeason() {
        const title = 'æ¸¬è©¦ç„¡æ•ˆå­£ç¯€åƒæ•¸';
        try {
            // We call apiFetch directly to catch the expected error
            await apiFetch(`/api/wardrobe/items?userId=${userId}&season=invalidseason`);
        } catch (err) {
            if (err.status === 400) {
                logResult(title + ' (æˆåŠŸæ””æˆªéŒ¯èª¤)', err, true);
            } else {
                logResult(title + ' (æœªæ””æˆªåˆ°é æœŸéŒ¯èª¤)', err, false);
            }
        }
    }

    // --- Test Functions (Tag System) ---
    async function createItemWithTags() {
        try {
            const newItemDto = { userId, name: 'ç™½è‰²è¥¯è¡«', type: 'top', season: 'spring', tags: ['ç´„æœƒç©¿', 'æœ€æ„›'], imageUrl: 'img.jpg', colors:['white'], purchased: true };
            const result = await apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(newItemDto) });
            tagTestItemId = result.id;
            logResult('1. æ–°å¢å¸¶æ¨™ç±¤è¡£ç‰©æˆåŠŸ', { ...result, note: `å·²å„²å­˜ ID: ${tagTestItemId}` }, true);
        } catch (err) { logResult('1. æ–°å¢å¸¶æ¨™ç±¤è¡£ç‰©å¤±æ•—', err, false); }
    }
    async function addTag() {
        if (!tagTestItemId) { logResult('æ–°å¢æ¨™ç±¤å¤±æ•—', { error: "å°šæœªå»ºç«‹æ¨™ç±¤æ¸¬è©¦è¡£ç‰©" }, false); return; }
        try {
            const result = await apiFetch('/api/wardrobe/tags', { method: 'POST', body: JSON.stringify({ userId, itemId: tagTestItemId, tag: 'é‹å‹•é¢¨', action: 'add' }) });
            logResult('2. æ–°å¢æ¨™ç±¤æˆåŠŸ', result, true);
        } catch (err) { logResult('2. æ–°å¢æ¨™ç±¤å¤±æ•—', err, false); }
    }
    async function removeTag() {
        if (!tagTestItemId) { logResult('ç§»é™¤æ¨™ç±¤å¤±æ•—', { error: "å°šæœªå»ºç«‹æ¨™ç±¤æ¸¬è©¦è¡£ç‰©" }, false); return; }
        try {
            const result = await apiFetch('/api/wardrobe/tags', { method: 'POST', body: JSON.stringify({ userId, itemId: tagTestItemId, tag: 'ç´„æœƒç©¿', action: 'remove' }) });
            logResult('3. ç§»é™¤æ¨™ç±¤æˆåŠŸ', result, true);
        } catch (err) { logResult('3. ç§»é™¤æ¨™ç±¤å¤±æ•—', err, false); }
    }
    async function getAllUserTags() {
        try {
            const result = await apiFetch(`/api/wardrobe/tags?userId=${userId}`);
            logResult('4. å–å¾—æ‰€æœ‰æ¨™ç±¤æˆåŠŸ', result, true);
        } catch (err) { logResult('4. å–å¾—æ‰€æœ‰æ¨™ç±¤å¤±æ•—', err, false); }
    }
    async function testInvalidAction() {
        if (!tagTestItemId) { logResult('ç„¡æ•ˆ Action æ¸¬è©¦å¤±æ•—', { error: "å°šæœªå»ºç«‹æ¨™ç±¤æ¸¬è©¦è¡£ç‰©" }, false); return; }
        const title = '7. æ¸¬è©¦ç„¡æ•ˆ Action';
        try {
            await apiFetch('/api/wardrobe/tags', { method: 'POST', body: JSON.stringify({ userId, itemId: tagTestItemId, tag: 'test', action: 'delete' }) });
        } catch (err) {
            if (err.status === 400) { logResult(title + ' (æˆåŠŸæ””æˆªéŒ¯èª¤)', err, true); } else { logResult(title + ' (æœªæ””æˆªåˆ°é æœŸéŒ¯èª¤)', err, false); }
        }
    }

    // --- Event Listeners ---
    document.getElementById('btn-create').addEventListener('click', createItem);
    document.getElementById('btn-get-before').addEventListener('click', () => getItem(currentItemId, '2. æ›´æ–°å‰'));
    document.getElementById('btn-update').addEventListener('click', updateItem);
    document.getElementById('btn-get-after').addEventListener('click', () => getItem(currentItemId, '4. æ›´æ–°å¾Œ'));
    document.getElementById('btn-update-404').addEventListener('click', test404);
    document.getElementById('btn-update-400').addEventListener('click', test400);

    // Season filtering listeners
    document.getElementById('btn-seed-seasons').addEventListener('click', seedSeasonItems);
    document.getElementById('btn-filter-spring').addEventListener('click', () => getFilteredItems('spring', 'æŸ¥è©¢æ˜¥å­£è¡£ç‰©'));
    document.getElementById('btn-filter-summer').addEventListener('click', () => getFilteredItems('summer', 'æŸ¥è©¢å¤å­£è¡£ç‰©'));
    document.getElementById('btn-filter-fall').addEventListener('click', () => getFilteredItems('fall', 'æŸ¥è©¢ç§‹å­£è¡£ç‰©'));
    document.getElementById('btn-filter-winter').addEventListener('click', () => getFilteredItems('winter', 'æŸ¥è©¢å†¬å­£è¡£ç‰©'));
    document.getElementById('btn-filter-all').addEventListener('click', () => getFilteredItems(null, 'æŸ¥è©¢æ‰€æœ‰è¡£ç‰©'));
    document.getElementById('btn-filter-invalid').addEventListener('click', testInvalidSeason);

    // Tag system listeners
    document.getElementById('btn-tags-create').addEventListener('click', createItemWithTags);
    document.getElementById('btn-tags-add').addEventListener('click', addTag);
    document.getElementById('btn-tags-remove').addEventListener('click', removeTag);
    document.getElementById('btn-tags-get-all').addEventListener('click', getAllUserTags);
    document.getElementById('btn-tags-filter-tag').addEventListener('click', () => getFilteredItems(null, '5. ä¾æ¨™ç±¤éæ¿¾', 'æœ€æ„›'));
    document.getElementById('btn-tags-filter-combo').addEventListener('click', () => getFilteredItems('spring', '6. å­£ç¯€+æ¨™ç±¤çµ„åˆéæ¿¾', 'æœ€æ„›'));
    document.getElementById('btn-tags-action-invalid').addEventListener('click', testInvalidAction);

  </script>
</body>
</html>