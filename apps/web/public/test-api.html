<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>衣櫃 API 測試工具</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
    h1, h2, h3, h4 { color: #333; }
    .test-section { background-color: #fff; border: 1px solid #ddd; padding: 1.5em; margin-bottom: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .test-group { border-top: 1px solid #eee; margin-top: 1.5em; padding-top: 1.5em; }
    button { padding: 10px 15px; font-size: 14px; margin: 5px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background-color: #e9e9e9; transition: background-color 0.2s; }
    button:hover { background-color: #ddd; }
    button:disabled { background-color: #f0f0f0; color: #aaa; cursor: not-allowed; }
    pre { padding: 1em; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: "SF Mono", "Fira Code", "Consolas", monospace; background-color: #2d2d2d; color: #f1f1f1; }
    .success { background-color: #e8f5e9; border-left: 5px solid #4caf50; }
    .error { background-color: #ffebee; border-left: 5px solid #f44336; }
    #result { margin-top: 1em; }
    .note { font-size: 0.9em; color: #666; margin-top: 10px;}
    .form-grid { display: grid; grid-template-columns: 150px 1fr; gap: 10px; align-items: center; margin-top: 15px; }
    .form-grid label { font-weight: bold; text-align: right; }
    .form-grid input[type="text"], .form-grid select, .form-grid input[type="file"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .form-grid .checkbox-group { display: flex; align-items: center; }
    .form-grid .checkbox-group input { margin-right: 5px; }
    .required-star { color: #f44336; margin-left: 2px; }
  </style>
</head>
<body>

  <h1>衣櫃 API 測試工具</h1>

  <div class="test-section">
    <h2> 圖片上傳並建立衣物</h2>
    <p class="note">此功能會將圖片與衣物資訊一同上傳，並在成功後建立一個新的 Wardrobe Item。</p>
    
    <div class="form-grid">
      <label for="uploadFile">圖片檔案<span class="required-star">*</span></label>
      <input type="file" id="uploadFile" accept="image/jpeg,image/png,image/webp">
    </div>

    <div class="form-grid">
        <label for="userId">UserID</label>
        <input type="text" id="userId" value="test-user-001">
    </div>
    <div class="form-grid">
        <label for="name">衣服名稱<span class="required-star">*</span></label>
        <input type="text" id="name" placeholder="例如: 白色棉質 T-shirt">
    </div>
    <div class="form-grid">
        <label for="type">類型<span class="required-star">*</span></label>
        <select id="type">
            <option value="top">上衣 (top)</option>
            <option value="bottom">下著 (bottom)</option>
            <option value="outerwear">外套 (outerwear)</option>
            <option value="shoes">鞋子 (shoes)</option>
            <option value="accessory">配件 (accessory)</option>
        </select>
    </div>
    <div class="form-grid">
        <label for="season">季節</label>
        <select id="season">
            <option value="all-season">四季 (all-season)</option>
            <option value="spring">春季 (spring)</option>
            <option value="summer">夏季 (summer)</option>
            <option value="autumn">秋季 (autumn)</option>
            <option value="winter">冬季 (winter)</option>
        </select>
    </div>
    <div class="form-grid">
        <label for="colors">顏色</label>
        <input type="text" id="colors" placeholder="用逗號分隔, 例如: white,gray">
    </div>
    <div class="form-grid">
        <label for="tags">標籤</label>
        <input type="text" id="tags" placeholder="用逗號分隔, 例如: casual,favorite">
     </div>
    <div class="form-grid">
        <label for="purchased">是否已購買</label>
        <div class="checkbox-group">
            <input type="checkbox" id="purchased" checked>
        </div>
    </div>

    <div style="margin-top: 20px; text-align: right;">
      <button onclick='uploadImage()' id='uploadBtn'>上傳並建立衣物</button>
    </div>
    
    <!-- 進度條 -->
    <div id='uploadProgress' style='display: none; margin-top: 10px;'>
      <div style='background: #f0f0f0; border-radius: 4px; overflow: hidden; height: 24px; position: relative;'>
        <div id='progressBar' style='background: linear-gradient(90deg, #4CAF50, #45a049); height: 100%; width: 0%; transition: width 0.3s ease;'></div>
        <div id='progressText' style='position: absolute; top: 0; left: 0; right: 0; text-align: center; line-height: 24px; color: #333; font-weight: bold; font-size: 12px;'>0%</div>
      </div>
      <div id='progressStatus' style='margin-top: 5px; font-size: 12px; color: #666;'></div>
    </div>
    
    <div id='uploadStatus' style='margin-top: 10px;'></div>
    
    <div class="test-group">
      <h3>上傳結果</h3>
      <div id="uploadResult">尚未上傳</div>
      <div id="wardrobeItemInfo" style="margin-top: 10px; font-size: 14px;"></div>
      <div id="imagePreviews" style="display: flex; gap: 20px; margin-top: 10px;">
          <div id="originalContainer" style="display:none;">
              <h4>原圖</h4>
              <img id="uploadPreview" style="max-width: 300px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          <div id="removedContainer" style="display:none;">
              <h4>去背圖</h4>
              <img id="removedBgPreview" style="max-width: 300px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
      </div>
    </div>
  </div>

  <div class="test-section">
    <h2>批量上傳測試</h2>
    <input type="file" id="batchFileInput" multiple accept="image/*">
    <button id="batchUploadButton">批次上傳</button>
    <p class="note">按住 Shift 或 Ctrl 選擇多個檔案。並發上傳數量限制為 2。</p>
    <div id="batchProgress"></div>
    <h3>批次上傳結果:</h3>
    <div id="batchResults"></div>
  </div>

  <div class="test-section">
    <h2>正常更新流程 (Happy Path)</h2>
    <p>依序點擊按鈕來測試完整的建立、讀取、更新、再讀取流程。</p>
    <button id="btn-create">1. 新增測試衣物 (POST)</button>
    <button id="btn-get-before">2. 取得更新前資料 (GET)</button>
    <button id="btn-update">3. 更新衣物名稱 (PUT)</button>
    <button id="btn-get-after">4. 取得更新後資料 (GET)</button>
    <p class="note">將使用固定的 UserID: 'test-user-001'。新增的物品 ID 會被暫存以供後續步驟使用。</p>
  </div>

  <div class="test-section">
    <h2>錯誤處理測試 (Error Cases)</h2>
    <button id="btn-update-404">測試更新不存在的 ID (應回傳 404)</button>
    <button id="btn-update-400">測試缺少 userId 的請求 (應回傳 400)</button>
  </div>

  <div class="test-section">
    <h2> 季節過濾測試</h2>
    <button id="btn-seed-seasons">1. 新增各季節的測試衣物</button>
    <br>
    <button id="btn-filter-spring">測試春季 (spring)</button>
    <button id="btn-filter-summer">測試夏季 (summer)</button>
    <button id="btn-filter-fall">測試秋季 (fall)</button>
    <button id="btn-filter-winter">測試冬季 (winter)</button>
    <br>
    <button id="btn-filter-all">測試不過濾 (應回傳所有)</button>
    <button id="btn-filter-invalid">測試無效季節 (應回傳 400)</button>
  </div>

  <div class="test-section">
      <h2>️ 標籤系統測試</h2>
      <button id="btn-tags-create">1. 新增帶有標籤的衣物</button>
      <button id="btn-tags-add">2. 為衣物新增標籤 ('運動風')</button>
      <button id="btn-tags-remove">3. 為衣物移除標籤 ('約會穿')</button>
      <button id="btn-tags-get-all">4. 取得使用者所有標籤</button>
      <br>
      <button id="btn-tags-filter-tag">5. 依標籤過濾 ('最愛')</button>
      <button id="btn-tags-filter-combo">6. 季節+標籤組合過濾</button>
      <button id="btn-tags-action-invalid">7. 測試無效 Action</button>
      <p class="note">此區塊的測試會使用獨立的 Item ID。</p>
  </div>

  <div class="test-section">
      <h2> 購買狀態測試</h2>
      <button id="btn-purchased-seed">1. 新增已購買和 Wishlist 衣物</button>
      <br>
      <button id="btn-purchased-filter-true">查詢已購買</button>
      <button id="btn-purchased-filter-false">查詢 Wishlist</button>
      <button id="btn-purchased-combo-season">組合查詢 (春季已購買)</button>
      <button id="btn-purchased-combo-tag">組合查詢 (有'最愛'標籤的 Wishlist)</button>
  </div>

  <div class="test-section">
      <h2> 搭配組合測試</h2>
      <div class="test-group">
          <h4>1. 準備衣物</h4>
          <button id="btn-outfit-prep-1">新增白色襯衫</button>
          <button id="btn-outfit-prep-2">新增黑色西裝褲</button>
          <button id="btn-outfit-prep-3">新增棕色皮鞋</button>
          <p class="note">請先新增這三件衣物來準備建立搭配組合。</p>
      </div>
      <div class="test-group">
          <h4>2. CRUD 測試</h4>
          <button id="btn-outfit-crud-create">建立搭配</button>
          <button id="btn-outfit-crud-get-all">查詢所有搭配</button>
          <button id="btn-outfit-crud-get-one">查詢單一搭配</button>
          <button id="btn-outfit-crud-update">更新搭配</button>
          <button id="btn-outfit-crud-delete">刪除搭配</button>
      </div>
      <div class="test-group">
          <h4>3. 過濾測試</h4>
          <button id="btn-outfit-filter-seed">建立過濾用搭配</button>
          <button id="btn-outfit-filter-season">依季節過濾 (spring)</button>
          <button id="btn-outfit-filter-occasion">依場合過濾 (約會)</button>
          <button id="btn-outfit-filter-tag">依標籤過濾 (浪漫)</button>
      </div>
      <div class="test-group">
          <h4>4. 錯誤處理</h4>
          <button id="btn-outfit-error-no-items">測試缺少 itemIds</button>
          <button id="btn-outfit-error-season">測試無效 season</button>
          <button id="btn-outfit-error-rating">測試無效 rating</button>
      </div>
  </div>

  <h2>測試結果</h2>
  <pre id="result">點擊按鈕以開始測試...</pre>

  <script>
    /**
     * 壓縮圖片
     * @param {File} file - 原始圖片檔案  
     * @param {number} maxWidth - 最大寬度 (預設 1200)
     * @param {number} maxHeight - 最大高度 (預設 1200)
     * @param {number} quality - 壓縮品質 0-1 (預設 0.85)
     * @returns {Promise<File>} 壓縮後的圖片檔案
     */
    async function compressImage(file, maxWidth = 1200, maxHeight = 1200, quality = 0.85) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          
          img.onload = () => {
            let width = img.width;
            let height = img.height;
            
            if (width > height) {
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
              }
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob(
              (blob) => {
                const compressedFile = new File([blob], file.name, {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                resolve(compressedFile);
              },
              'image/jpeg',
              quality
            );
          };
          
          img.onerror = () => reject(new Error('圖片載入失敗'));
        };
        
        reader.onerror = () => reject(new Error('檔案讀取失敗'));
      });
    }

    const resultEl = document.getElementById('result');
    const userId = 'test-user-001';
    let currentItemId = null;
    let tagTestItemId = null;
    let testItemIds = [];
    let testOutfitId = null;
    let uploadedImageUrl = null;

    // --- Helper Functions ---
    function logResult(title, data, success) {
      let content = `<h3>${title}</h3>`;
      if (data) {
        if (Array.isArray(data)) {
          content += `<p>找到 ${data.length} 件項目。</p>`;
        }
        content += JSON.stringify(data, null, 2);
      }
      resultEl.innerHTML = content;
      resultEl.className = success ? 'success' : 'error';
    }

    async function apiFetch(url, options = {}) {
      try {
        const defaultHeaders = options.body instanceof FormData ? {} : { 'Content-Type': 'application/json' };
        const response = await fetch(url, {
          headers: { ...defaultHeaders, ...options.headers },
          ...options,
        });
        const data = response.status === 204 ? null : await response.json();
        if (!response.ok) {
          throw { status: response.status, data };
        }
        return data;
      } catch (err) {
        console.error('API Error:', err);
        throw err;
      }
    }

    // --- Refactored Filter Function ---
    async function getFilteredItems(title, params = {}) {
        const query = new URLSearchParams({ userId });
        if (params.season) query.set('season', params.season);
        if (params.tag) query.set('tag', params.tag);
        if (params.purchased !== undefined) query.set('purchased', params.purchased);
        
        try {
            const result = await apiFetch(`/api/wardrobe/items?${query.toString()}`);
            logResult(title, result, true);
        } catch (err) { logResult(`${title} - 失敗`, err, false); }
    }

    /**
     * 更新進度條
     * @param {number} percent - 進度百分比 0-100
     * @param {string} status - 狀態文字
     */
    function updateProgress(percent, status) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressStatus = document.getElementById('progressStatus');
      const progressContainer = document.getElementById('uploadProgress');
      
      progressContainer.style.display = 'block';
      progressBar.style.width = percent + '%';
      progressText.textContent = Math.round(percent) + '%';
      progressStatus.textContent = status;
    }

    /**
     * 隱藏進度條
     */
    function hideProgress() {
      document.getElementById('uploadProgress').style.display = 'none';
    }

    /**
     * 重置進度條
     */
    function resetProgress() {
      updateProgress(0, '準備中...');
    }

    // --- Test Functions (Image Upload) ---
    async function uploadImage() {
      const fileInput = document.getElementById('uploadFile');
      const file = fileInput.files[0];
      const statusDiv = document.getElementById('uploadStatus');
      const uploadBtn = document.getElementById('uploadBtn');
      
      if (!file) {
        statusDiv.innerHTML = '<p style="color: red;">請選擇一個圖片檔案。</p>';
        return;
      }
      if (!document.getElementById('name').value) {
        statusDiv.innerHTML = '<p style="color: red;">請輸入衣服名稱。</p>';
        return;
      }
      
      try {
        uploadBtn.disabled = true;
        uploadBtn.textContent = '處理中...';
        resetProgress();
        statusDiv.innerHTML = '';
        
        const originalSize = (file.size / 1024).toFixed(2);
        console.log(' 原始檔案:', file.name, originalSize + 'KB');
        
        updateProgress(10, ' 正在壓縮圖片...');
        const compressedFile = await compressImage(file, 1200, 1200, 0.85);
        const compressedSize = (compressedFile.size / 1024).toFixed(2);
        const reduction = ((1 - compressedFile.size / file.size) * 100).toFixed(1);
        console.log(' 壓縮完成:', compressedFile.name, compressedSize + 'KB', '減少 ' + reduction + '%');
        updateProgress(30, ' 壓縮完成 (' + originalSize + 'KB → ' + compressedSize + 'KB)');
        
        await new Promise(resolve => setTimeout(resolve, 300));
        
        updateProgress(40, '⬆️ 開始上傳...');
        
        const formData = new FormData();
        formData.append('file', compressedFile);
        formData.append('userId', document.getElementById('userId').value);
        formData.append('name', document.getElementById('name').value);
        formData.append('type', document.getElementById('type').value);
        formData.append('season', document.getElementById('season').value);
        formData.append('purchased', document.getElementById('purchased').checked ? 'true' : 'false');

        const colors = document.getElementById('colors').value.split(',').map(c => c.trim()).filter(c => c);
        if (colors.length > 0) {
          formData.append('colors', JSON.stringify(colors));
        }

        const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);
        if (tags.length > 0) {
          formData.append('tags', JSON.stringify(tags));
        }
        
        const result = await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
              const uploadPercent = (e.loaded / e.total) * 100;
              const totalPercent = 40 + (uploadPercent * 0.5);
              updateProgress(totalPercent, '⬆️ 上傳中... ' + uploadPercent.toFixed(0) + '%');
            }
          });
          xhr.addEventListener('load', () => {
            const responseJson = JSON.parse(xhr.responseText);
            if (xhr.status === 200 || xhr.status === 201) {
              resolve(responseJson);
            } else {
              reject(new Error(responseJson.error || '上傳失敗'));
            }
          });
          xhr.addEventListener('error', () => reject(new Error('網路錯誤')));
          xhr.addEventListener('abort', () => reject(new Error('上傳已取消')));
          xhr.open('POST', '/api/upload');
          xhr.send(formData);
        });
        
        updateProgress(100, ' 上傳成功!');
        
        const data = result;
        console.log(' API Response:', data);

        let successMessage = `<p style="color: green; font-weight: bold;"> ${data.wardrobeItem ? '衣物建立成功!' : '圖片上傳成功!'}</p>` +
          '<p style="font-size: 12px;">壓縮: ' + originalSize + 'KB → ' + compressedSize + 'KB (減少 ' + reduction + '%)</p>' +
          '<p style="font-size: 12px;">總處理時間: ' + data.processingTime.toFixed(2) + ' 秒</p>';
        if (data.backgroundRemoved === false && data.error) {
            successMessage += '<p style="color: #d8a044; font-weight: bold;">' + data.error + '</p>';
        }
        statusDiv.innerHTML = successMessage;

        document.getElementById('uploadResult').innerHTML =
          '<pre style="font-size: 11px;">' + JSON.stringify(data, null, 2) + '</pre>';

        const wardrobeInfoDiv = document.getElementById('wardrobeItemInfo');
        if (data.wardrobeItem) {
            const item = data.wardrobeItem;
            wardrobeInfoDiv.innerHTML = `
                <h4>建立的衣物資訊:</h4>
                <p><strong>ID:</strong> ${item.id}</p>
                <p><strong>名稱:</strong> ${item.name}</p>
                <p><strong>類型:</strong> ${item.type}</p>
                <p><strong>季節:</strong> ${item.season}</p>
            `;
        } else {
            wardrobeInfoDiv.innerHTML = '';
        }

        const originalContainer = document.getElementById('originalContainer');
        const removedContainer = document.getElementById('removedContainer');
        const uploadPreview = document.getElementById('uploadPreview');
        const removedBgPreview = document.getElementById('removedBgPreview');

        originalContainer.style.display = 'none';
        removedContainer.style.display = 'none';

        if (data.success && data.originalUrl) {
            uploadPreview.src = data.originalUrl;
            originalContainer.style.display = 'block';

            if (data.backgroundRemoved && data.removedBgUrl) {
                removedBgPreview.src = data.removedBgUrl;
                removedContainer.style.display = 'block';
            }
        }
        
        setTimeout(() => { hideProgress(); }, 2000);
        
      } catch (error) {
        console.error(' 上傳錯誤:', error);
        hideProgress();
        statusDiv.innerHTML = '<p style="color: red;"> 上傳失敗: ' + error.message + '</p>';
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = '上傳並建立衣物';
      }
    }

    async function addItemWithImage() {
        if (!uploadedImageUrl) {
            logResult('新增衣物失敗', { error: '請先成功上傳一張圖片' }, false);
            return;
        }
        const dto = { userId, name: '衣物 (含圖)', type: 'top', season: 'all-season', imageUrl: uploadedImageUrl, purchased: true, colors:['multi'] };
        try {
            const result = await apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(dto) });
            logResult('使用上傳的圖片新增衣物成功', result, true);
        } catch (err) {
            logResult('使用上傳的圖片新增衣物失敗', err, false);
        }
    }

    // --- Batch Upload Functions ---
    async function compressImageAsBlob(file, maxSize = 1200, quality = 0.85) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onerror = () => reject(new Error("File reader error."));
        reader.onload = (event) => {
          if (!event.target?.result) {
            return reject(new Error("Failed to read file."));
          }
          const img = new Image();
          img.src = event.target.result;
          img.onerror = () => reject(new Error("Image failed to load."));
          img.onload = () => {
            let width = img.width;
            let height = img.height;
            if (width > height) {
              if (width > maxSize) {
                height = (height * maxSize) / width;
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = (width * maxSize) / height;
                height = maxSize;
              }
            }
            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            if (!ctx) {
              return reject(new Error("Failed to get canvas context."));
            }
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob(
              (blob) => {
                if (!blob) {
                  return reject(new Error("Canvas toBlob failed."));
                }
                resolve(blob);
              },
              "image/jpeg",
              quality
            );
          };
        };
      });
    }

    async function batchUpload(files, onProgress, maxConcurrent = 2) {
      const results = [];
      const queue = [...files];
      let processedCount = 0;

      async function uploadSingleFile(file) {
        const formData = new FormData();
        formData.append('file', file, file.name);
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData,
        });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Server error' }));
          throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        return response.json();
      }

      const processFile = async (file) => {
        try {
          onProgress({ processed: processedCount, total: files.length, fileName: file.name, status: 'compressing' });
          const compressedBlob = await compressImageAsBlob(file);
          const compressedFile = new File([compressedBlob], file.name, { type: 'image/jpeg' });

          onProgress({ processed: processedCount, total: files.length, fileName: file.name, status: 'uploading' });
          const result = await uploadSingleFile(compressedFile);
          
          results.push({ ...result, fileName: file.name });
          processedCount++;
          onProgress({ processed: processedCount, total: files.length, fileName: file.name, status: 'completed' });
        } catch (error) {
          results.push({
            success: false,
            error: error.message || 'Unknown error',
            fileName: file.name,
          });
          processedCount++;
          onProgress({ processed: processedCount, total: files.length, fileName: file.name, status: 'error' });
        }
      };

      const workers = Array(maxConcurrent).fill(null).map(async () => {
        while (queue.length > 0) {
          const file = queue.shift();
          if (file) {
            await processFile(file);
          }
        }
      });

      await Promise.all(workers);
      return results;
    }

    // --- Test Functions (Original) ---
    async function createItem() {
      try {
        const newItemDto = { userId, name: '復古牛仔夾克', type: 'outerwear', imageUrl: 'http://example.com/image.jpg', colors: ['blue'], season: 'all-season', purchased: true };
        const result = await apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(newItemDto) });
        currentItemId = result.id;
        logResult('1. 新增衣物成功', { ...result, note: `已儲存 ID: ${currentItemId}` }, true);
      } catch (err) { logResult('1. 新增衣物失敗', err, false); }
    }
    async function getItem(id, step) {
      if (!id) { logResult(`${step}. 取得資料失敗`, { error: "尚未建立衣物" }, false); return; }
      try {
        const result = await apiFetch(`/api/wardrobe/items/${id}`);
        logResult(`${step}. 取得資料成功`, result, true);
        return result;
      } catch (err) { logResult(`${step}. 取得資料失敗`, err, false); }
    }
    async function updateItem() {
      if (!currentItemId) { logResult('3. 更新失敗', { error: "尚未建立衣物" }, false); return; }
      try {
        const updateDto = { userId, name: '摩登皮夾克 (已更新)', colors: ['black'] };
        const result = await apiFetch(`/api/wardrobe/items/${currentItemId}`, { method: 'PUT', body: JSON.stringify(updateDto) });
        logResult('3. 更新成功', result, true);
      } catch (err) { logResult('3. 更新失敗', err, false); }
    }
    async function test404() {
      try { await apiFetch('/api/wardrobe/items/non-existent-id-12345', { method: 'PUT', body: JSON.stringify({ userId, name: 'test' }) }); } catch (err) {
        if (err.status === 404) { logResult('404 測試成功', err, true); } else { logResult('404 測試失敗', err, false); }
      }
    }
    async function test400() {
        if (!currentItemId) { logResult('400 測試失敗', { error: "尚未建立衣物" }, false); return; }
        try { await apiFetch(`/api/wardrobe/items/${currentItemId}`, { method: 'PUT', body: JSON.stringify({ name: 'a new name without userId' }) }); } catch (err) {
            if (err.status === 400) { logResult('400 測試成功', err, true); } else { logResult('400 測試失敗', err, false); }
        }
    }

    // --- Test Functions (Season Filtering) ---
    async function seedSeasonItems() {
        const itemsToCreate = [ { name: '春季薄衫', season: 'spring', type: 'top' }, { name: '夏季短褲', season: 'summer', type: 'bottom' }, { name: '秋季風衣', season: 'fall', type: 'outerwear' }, { name: '冬季毛衣', season: 'winter', type: 'top' } ];
        try {
            const promises = itemsToCreate.map(item => apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify({ ...item, userId, imageUrl: 'img.jpg', colors:['red'], purchased: false }) }));
            const results = await Promise.all(promises);
            logResult('季節衣物新增成功', results, true);
        } catch (err) { logResult('季節衣物新增失敗', err, false); }
    }
    async function testInvalidSeason() {
        const title = '測試無效季節參數';
        try { await apiFetch(`/api/wardrobe/items?userId=${userId}&season=invalidseason`); } catch (err) {
            if (err.status === 400) { logResult(title + ' (成功攔截錯誤)', err, true); } else { logResult(title + ' (未攔截到預期錯誤)', err, false); }
        }
    }

    // --- Test Functions (Tag System) ---
    async function createItemWithTags() {
        try {
            const newItemDto = { userId, name: '白色襯衫', type: 'top', season: 'spring', tags: ['約會穿', '最愛'], imageUrl: 'img.jpg', colors:['white'], purchased: true };
            const result = await apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(newItemDto) });
            tagTestItemId = result.id;
            logResult('1. 新增帶標籤衣物成功', { ...result, note: `已儲存 ID: ${tagTestItemId}` }, true);
        } catch (err) { logResult('1. 新增帶標籤衣物失敗', err, false); }
    }
    async function addTag() {
        if (!tagTestItemId) { logResult('新增標籤失敗', { error: "尚未建立標籤測試衣物" }, false); return; }
        try {
            const result = await apiFetch('/api/wardrobe/tags', { method: 'POST', body: JSON.stringify({ userId, itemId: tagTestItemId, tag: '運動風', action: 'add' }) });
            logResult('2. 新增標籤成功', result, true);
        } catch (err) { logResult('2. 新增標籤失敗', err, false); }
    }
    async function removeTag() {
        if (!tagTestItemId) { logResult('移除標籤失敗', { error: "尚未建立標籤測試衣物" }, false); return; }
        try {
            const result = await apiFetch('/api/wardrobe/tags', { method: 'POST', body: JSON.stringify({ userId, itemId: tagTestItemId, tag: '約會穿', action: 'remove' }) });
            logResult('3. 移除標籤成功', result, true);
        } catch (err) { logResult('3. 移除標籤失敗', err, false); }
    }
    async function getAllUserTags() {
        try {
            const result = await apiFetch(`/api/wardrobe/tags?userId=${userId}`);
            logResult('4. 取得所有標籤成功', result, true);
        } catch (err) { logResult('4. 取得所有標籤失敗', err, false); }
    }
    async function testInvalidAction() {
        if (!tagTestItemId) { logResult('無效 Action 測試失敗', { error: "尚未建立標籤測試衣物" }, false); return; }
        const title = '7. 測試無效 Action';
        try { await apiFetch('/api/wardrobe/tags', { method: 'POST', body: JSON.stringify({ userId, itemId: tagTestItemId, tag: 'test', action: 'delete' }) }); } catch (err) {
            if (err.status === 400) { logResult(title + ' (成功攔截錯誤)', err, true); } else { logResult(title + ' (未攔截到預期錯誤)', err, false); }
        }
    }

    // --- Test Functions (Purchase Status) ---
    async function seedPurchaseStatusItems() {
        const purchasedItem = { userId, name: '黑色西裝外套', type: 'top', season: 'spring', purchased: true, imageUrl: 'img.jpg', colors:['black'] };
        const wishlistItem = { userId, name: '夢想中的皮衣', type: 'outerwear', season: 'fall', purchased: false, tags: ['最愛'], imageUrl: 'img.jpg', colors:['brown'] };
        try {
            const results = await Promise.all([ apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(purchasedItem) }), apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify(wishlistItem) }) ]);
            logResult('購買狀態衣物新增成功', results, true);
        } catch (err) { logResult('購買狀態衣物新增失敗', err, false); }
    }

    // --- Test Functions (Outfit) ---
    async function createTestWardrobeItem(dto, title) {
        try {
            const result = await apiFetch('/api/wardrobe/items', { method: 'POST', body: JSON.stringify({ ...dto, userId, imageUrl: 'img.jpg', colors:['default'], purchased: true }) });
            testItemIds.push(result.id);
            logResult(title, { ...result, note: `已儲存衣物 ID: ${result.id}。目前衣物數: ${testItemIds.length}` }, true);
        } catch (err) { logResult(title, err, false); }
    }
    async function createTestOutfit() {
        if (testItemIds.length < 3) { logResult('建立搭配失敗', { error: "請先新增 3 件準備衣物" }, false); return; }
        try {
            const dto = { userId, name: '商務會議穿搭', description: '正式場合專用', itemIds: testItemIds, occasion: '上班', tags: ['正式', '商務'] };
            const result = await apiFetch('/api/outfits', { method: 'POST', body: JSON.stringify(dto) });
            testOutfitId = result.id;
            logResult('建立搭配成功', { ...result, note: `已儲存搭配 ID: ${testOutfitId}` }, true);
        } catch (err) { logResult('建立搭配失敗', err, false); }
    }
    async function getAllTestOutfits() {
        try {
            const result = await apiFetch(`/api/outfits?userId=${userId}`);
            logResult('查詢所有搭配成功', result, true);
        } catch (err) { logResult('查詢所有搭配失敗', err, false); }
    }
    async function getSingleTestOutfit() {
        if (!testOutfitId) { logResult('查詢單一搭配失敗', { error: "尚未建立搭配" }, false); return; }
        try {
            const result = await apiFetch(`/api/outfits/${testOutfitId}?userId=${userId}`);
            logResult('查詢單一搭配成功', result, true);
        } catch (err) { logResult('查詢單一搭配失敗', err, false); }
    }
    async function updateTestOutfit() {
        if (!testOutfitId) { logResult('更新搭配失敗', { error: "尚未建立搭配" }, false); return; }
        try {
            const updates = { userId, name: '商務會議穿搭 (更新版)', tags: ['正式', '商務', '重要會議'], rating: 5 };
            const result = await apiFetch(`/api/outfits/${testOutfitId}`, { method: 'PUT', body: JSON.stringify(updates) });
            logResult('更新搭配成功', result, true);
        } catch (err) { logResult('更新搭配失敗', err, false); }
    }
    async function deleteTestOutfit() {
        if (!testOutfitId) { logResult('刪除搭配失敗', { error: "尚未建立搭配" }, false); return; }
        try {
            const result = await apiFetch(`/api/outfits/${testOutfitId}?userId=${userId}`, { method: 'DELETE' });
            logResult('刪除搭配成功', result, true);
            testOutfitId = null; // Clear the ID after deletion
        } catch (err) { logResult('刪除搭配失敗', err, false); }
    }
    async function createFilterTestData() {
        const outfit1 = { userId, name: '春季約會搭配', itemIds: [testItemIds[0] || 'item1'], season: 'spring', occasion: '約會', tags: ['浪漫'] };
        const outfit2 = { userId, name: '夏季運動搭配', itemIds: [testItemIds[1] || 'item2'], season: 'summer', occasion: '運動', tags: ['休閒'] };
        try {
            const results = await Promise.all([
                apiFetch('/api/outfits', { method: 'POST', body: JSON.stringify(outfit1) }),
                apiFetch('/api/outfits', { method: 'POST', body: JSON.stringify(outfit2) })
            ]);
            logResult('建立過濾用搭配成功', results, true);
        } catch (err) { logResult('建立過濾用搭配失敗', err, false); }
    }
    async function getFilteredOutfits(title, params = {}) {
        const query = new URLSearchParams({ userId });
        if (params.season) query.set('season', params.season);
        if (params.tag) query.set('tag', params.tag);
        if (params.occasion) query.set('occasion', params.occasion);
        try {
            const result = await apiFetch(`/api/outfits?${query.toString()}`);
            logResult(title, result, true);
        } catch (err) { logResult(`${title} - 失敗`, err, false); }
    }
    async function testOutfitError(title, dto) {
        try {
            await apiFetch('/api/outfits', { method: 'POST', body: JSON.stringify({ userId, name: '錯誤測試', ...dto }) });
        } catch (err) {
            if (err.status === 400) { logResult(title + ' (成功攔截錯誤)', err, true); } else { logResult(title + ' (未攔截到預期錯誤)', err, false); }
        }
    }

    // --- Event Listeners ---
    document.getElementById('btn-create').addEventListener('click', createItem);
    document.getElementById('btn-get-before').addEventListener('click', () => getItem(currentItemId, '2. 更新前'));
    document.getElementById('btn-update').addEventListener('click', updateItem);
    document.getElementById('btn-get-after').addEventListener('click', () => getItem(currentItemId, '4. 更新後'));
    document.getElementById('btn-update-404').addEventListener('click', test404);
    document.getElementById('btn-update-400').addEventListener('click', test400);

    // Season filtering listeners
    document.getElementById('btn-seed-seasons').addEventListener('click', seedSeasonItems);
    document.getElementById('btn-filter-spring').addEventListener('click', () => getFilteredItems('查詢春季衣物', { season: 'spring' }));
    document.getElementById('btn-filter-summer').addEventListener('click', () => getFilteredItems('查詢夏季衣物', { season: 'summer' }));
    document.getElementById('btn-filter-fall').addEventListener('click', () => getFilteredItems('查詢秋季衣物', { season: 'fall' }));
    document.getElementById('btn-filter-winter').addEventListener('click', () => getFilteredItems('查詢冬季衣物', { season: 'winter' }));
    document.getElementById('btn-filter-all').addEventListener('click', () => getFilteredItems('查詢所有衣物', {}));
    document.getElementById('btn-filter-invalid').addEventListener('click', testInvalidSeason);

    // Tag system listeners
    document.getElementById('btn-tags-create').addEventListener('click', createItemWithTags);
    document.getElementById('btn-tags-add').addEventListener('click', addTag);
    document.getElementById('btn-tags-remove').addEventListener('click', removeTag);
    document.getElementById('btn-tags-get-all').addEventListener('click', getAllUserTags);
    document.getElementById('btn-tags-filter-tag').addEventListener('click', () => getFilteredItems('5. 依標籤過濾', { tag: '最愛' }));
    document.getElementById('btn-tags-filter-combo').addEventListener('click', () => getFilteredItems('6. 季節+標籤組合過濾', { season: 'spring', tag: '最愛' }));
    document.getElementById('btn-tags-action-invalid').addEventListener('click', testInvalidAction);

    // Purchase status listeners
    document.getElementById('btn-purchased-seed').addEventListener('click', seedPurchaseStatusItems);
    document.getElementById('btn-purchased-filter-true').addEventListener('click', () => getFilteredItems('查詢已購買', { purchased: 'true' }));
    document.getElementById('btn-purchased-filter-false').addEventListener('click', () => getFilteredItems('查詢 Wishlist', { purchased: 'false' }));
    document.getElementById('btn-purchased-combo-season').addEventListener('click', () => getFilteredItems('組合查詢 (春季已購買)', { season: 'spring', purchased: 'true' }));
    document.getElementById('btn-purchased-combo-tag').addEventListener('click', () => getFilteredItems('組合查詢 (有\'最愛\'標籤的 Wishlist)', { tag: '最愛', purchased: 'false' }));

    // Outfit listeners
    document.getElementById('btn-outfit-prep-1').addEventListener('click', () => createTestWardrobeItem({ name: '白色襯衫', type: 'top', season: 'all-season' }, '新增白色襯衫'));
    document.getElementById('btn-outfit-prep-2').addEventListener('click', () => createTestWardrobeItem({ name: '黑色西裝褲', type: 'bottom', season: 'all-season' }, '新增黑色西裝褲'));
    document.getElementById('btn-outfit-prep-3').addEventListener('click', () => createTestWardrobeItem({ name: '棕色皮鞋', type: 'shoes', season: 'all-season' }, '新增棕色皮鞋'));
    document.getElementById('btn-outfit-crud-create').addEventListener('click', createTestOutfit);
    document.getElementById('btn-outfit-crud-get-all').addEventListener('click', getAllTestOutfits);
    document.getElementById('btn-outfit-crud-get-one').addEventListener('click', getSingleTestOutfit);
    document.getElementById('btn-outfit-crud-update').addEventListener('click', updateTestOutfit);
    document.getElementById('btn-outfit-crud-delete').addEventListener('click', deleteTestOutfit);
    document.getElementById('btn-outfit-filter-seed').addEventListener('click', createFilterTestData);
    document.getElementById('btn-outfit-filter-season').addEventListener('click', () => getFilteredOutfits('依季節過濾 (spring)', { season: 'spring' }));
    document.getElementById('btn-outfit-filter-occasion').addEventListener('click', () => getFilteredOutfits('依場合過濾 (約會)', { occasion: '約會' }));
    document.getElementById('btn-outfit-filter-tag').addEventListener('click', () => getFilteredOutfits('依標籤過濾 (浪漫)', { tag: '浪漫' }));
    document.getElementById('btn-outfit-error-no-items').addEventListener('click', () => testOutfitError('測試缺少 itemIds', { itemIds: [] }));
    document.getElementById('btn-outfit-error-season').addEventListener('click', () => testOutfitError('測試無效 season', { itemIds: ['item1'], season: 'rainy' }));
    document.getElementById('btn-outfit-error-rating').addEventListener('click', () => testOutfitError('測試無效 rating', { itemIds: ['item1'], rating: 99 }));

    // Image Upload Listeners
    document.getElementById('btn-add-item-with-image').addEventListener('click', addItemWithImage);

    // Batch Upload Listener
    document.getElementById('batchUploadButton').addEventListener('click', async () => {
        const fileInput = document.getElementById('batchFileInput');
        const files = Array.from(fileInput.files);
        const progressDiv = document.getElementById('batchProgress');
        const resultsDiv = document.getElementById('batchResults');
        const uploadButton = document.getElementById('batchUploadButton');

        if (files.length === 0) {
            alert('Please select files to upload.');
            return;
        }

        uploadButton.disabled = true;
        uploadButton.textContent = 'Uploading...';
        resultsDiv.innerHTML = '';

        const onProgress = (progress) => {
            console.log('Progress:', progress);
            progressDiv.textContent = `Processing ${progress.processed}/${progress.total}... [${progress.status}] ${progress.fileName}`;
        };

        try {
            const results = await batchUpload(files, onProgress, 2);
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.style.border = '1px solid #ccc';
                item.style.padding = '10px';
                item.style.marginBottom = '10px';
                item.style.borderRadius = '4px';

                if (result.success) {
                    item.style.backgroundColor = '#e8f5e9';
                    item.innerHTML = `
                        <strong>${result.fileName}</strong> - Success! <br>
                        Original: <a href="${result.originalUrl}" target="_blank">Link</a> <img src="${result.originalUrl}" style="max-width:100px; vertical-align: middle;"/> <br>
                        ${result.removedBgUrl ? `Removed BG: <a href="${result.removedBgUrl}" target="_blank">Link</a> <img src="${result.removedBgUrl}" style="max-width:100px; vertical-align: middle;"/>` : 'No background removal.'}
                    `;
                } else {
                    item.style.backgroundColor = '#ffebee';
                    item.innerHTML = `<strong>${result.fileName}</strong> - Error: ${result.error}`;
                }
                resultsDiv.appendChild(item);
            });

        } catch (error) {
            resultsDiv.innerHTML = `<div style="background-color: #ffebee; border: 1px solid #ccc; padding: 10px;">Batch upload failed: ${error.message}</div>`;
            console.error(error);
        } finally {
            uploadButton.disabled = false;
            uploadButton.textContent = '批次上傳';
            progressDiv.textContent = `Done. Processed ${files.length}/${files.length}.`;
        }
    });

  </script>
</body>
</html>