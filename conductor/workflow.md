# 專案工作流程

## 指導原則

1.  **計畫是真相的來源**：所有工作都必須在 `plan.md` 中追蹤。
2.  **技術棧經過深思熟慮**：技術棧的變更必須在實作**之前**記錄在 `tech-stack.md` 中。
3.  **測試驅動開發**：在實作功能之前編寫單元測試。
4.  **高程式碼覆蓋率**：所有模組的程式碼覆蓋率目標為 >80%。
5.  **使用者體驗優先**：每個決策都應將使用者體驗放在首位。
6.  **非互動式與 CI 感知**：偏好非互動式命令。對於觀察模式工具（測試、linter），使用 `CI=true` 以確保單次執行。

## 任務工作流程

所有任務都遵循嚴格的生命週期：

### 標準任務工作流程

1.  **選擇任務**：從 `plan.md` 中按順序選擇下一個可用任務。

2.  **標記為進行中**：在開始工作之前，編輯 `plan.md` 並將任務狀態從 `[ ]` 更改為 `[~]`。

3.  **編寫失敗測試 (紅燈階段)**：
    -   為功能或錯誤修正創建一個新的測試檔案。
    -   編寫一個或多個單元測試，明確定義任務的預期行為和驗收標準。
    -   **關鍵**：運行測試並確認它們按預期失敗。這是 TDD 的「紅燈」階段。在測試失敗之前不要繼續。

4.  **實作以通過測試 (綠燈階段)**：
    -   編寫使失敗測試通過所需的最小應用程式程式碼量。
    -   再次運行測試套件並確認所有測試現在都通過。這是「綠燈」階段。

5.  **重構 (可選但推薦)**：
    -   在測試通過的安全性下，重構實作程式碼和測試程式碼，以提高清晰度，消除重複，並在不改變外部行為的情況下提高性能。
    -   重新運行測試以確保重構後它們仍然通過。

6.  **驗證覆蓋率**：使用專案選擇的工具運行覆蓋率報告。例如，在 Python 專案中，這可能看起來像：
    ```bash
    pytest --cov=app --cov-report=html
    ```
    目標：新程式碼的覆蓋率 >80%。具體工具和命令因語言和框架而異。

7.  **記錄偏差**：如果實作與技術棧不同：
    -   **停止**實作。
    -   使用新設計更新 `tech-stack.md`。
    -   添加日期註釋解釋變更。
    -   恢復實作。

8.  **提交程式碼變更**：
    -   暫存所有與任務相關的程式碼變更。
    -   提出清晰、簡潔的提交訊息，例如 `feat(ui): Create basic HTML structure for calculator`。
    -   執行提交。

9.  **使用 Git Notes 附加任務摘要**：
    -   **步驟 9.1：獲取提交哈希**：獲取**剛完成提交**的哈希值 (`git log -1 --format="%H"`)。
    -   **步驟 9.2：草擬註釋內容**：為已完成的任務創建詳細摘要。這應包括任務名稱、變更摘要、所有創建/修改的檔案列表以及變更的核心「原因」。
    -   **步驟 9.3：附加註釋**：使用 `git notes` 命令將摘要附加到提交。
        ```bash
        # 來自上一步的註釋內容透過 -m 旗標傳遞。
        git notes add -m "<note content>" <commit_hash>
        ```

10. **獲取並記錄任務提交 SHA**：
    -   **步驟 10.1：更新計畫**：讀取 `plan.md`，找到已完成任務的行，將其狀態從 `[~]` 更新為 `[x]`，並附加**剛完成提交**的提交哈希值的前 7 個字元。
    -   **步驟 10.2：寫入計畫**：將更新後的內容寫回 `plan.md`。

11. **提交計畫更新**：
    -   **操作**：暫存已修改的 `plan.md` 檔案。
    -   **操作**：使用遵循格式 `conductor(plan): Mark task 'Create user model' as complete` 的描述性訊息提交此變更。

### 階段完成驗證和檢查點協議

**觸發**：此協議在完成 `plan.md` 中同時結束一個階段的任務後立即執行。

1.  **宣布協議開始**：通知使用者階段已完成，並已啟動驗證和檢查點協議。

2.  **確保階段變更的測試覆蓋率**：
    -   **步驟 2.1：確定階段範圍**：要識別此階段中更改的檔案，您必須首先找到起點。讀取 `plan.md` 以查找**前一個**階段檢查點的 Git 提交 SHA。如果沒有前一個檢查點，則範圍是自首次提交以來的所有變更。
    -   **步驟 2.2：列出更改的檔案**：執行 `git diff --name-only <previous_checkpoint_sha> HEAD` 以獲取此階段中修改的所有檔案的精確列表。
    -   **步驟 2.3：驗證並創建測試**：對於列表中的每個檔案：
        -   **關鍵**：首先檢查其副檔名。排除非程式碼檔案（例如 `.json`、`.md`、`.yaml`）。
        -   對於每個剩餘的程式碼檔案，驗證是否存在相應的測試檔案。
        -   如果缺少測試檔案，您**必須**創建一個。在編寫測試之前，**首先分析儲存庫中的其他測試檔案以確定正確的命名約定和測試風格。** 新測試**必須**驗證此階段任務 (`plan.md`) 中描述的功能。

3.  **執行自動化測試並主動偵錯**：
    -   在執行之前，您**必須**宣布將用於運行測試的確切 shell 命令。
    -   **範例公告**：「我現在將運行自動化測試套件以驗證階段。**命令**：`CI=true npm test`」
    -   執行宣布的命令。
    -   如果測試失敗，您**必須**通知使用者並開始偵錯。您最多可以嘗試提出兩次修正。如果第二次修正後測試仍然失敗，您**必須停止**，報告持續的失敗，並請求使用者指導。

4.  **提出詳細、可執行的手動驗證計畫**：
    -   **關鍵**：要生成計畫，首先分析 `product.md`、`product-guidelines.md` 和 `plan.md` 以確定已完成階段的使用者導向目標。
    -   您**必須**生成一個逐步計畫，引導使用者完成驗證過程，包括任何必要的命令和具體預期結果。
    -   您呈現給使用者的計畫**必須**遵循以下格式：

        **對於前端變更**：
        ```
        自動化測試已通過。手動驗證步驟如下：

        **手動驗證步驟**：
        1.  **使用命令啟動開發伺服器**：`npm run dev`
        2.  **在瀏覽器中開啟**：`http://localhost:3000`
        3.  **確認您看到**：新的使用者個人資料頁面，使用者名稱和電子郵件正確顯示。
        ```

        **對於後端變更**：
        ```
        自動化測試已通過。手動驗證步驟如下：

        **手動驗證步驟**：
        1.  **確保伺服器正在運行。**
        2.  **在終端機中執行以下命令**：`curl -X POST http://localhost:8080/api/v1/users -d '{"name": "test"}'`
        3.  **確認您收到**：狀態為 `201 Created` 的 JSON 回應。
        ```

5.  **等待明確的使用者回饋**：
    -   在呈現詳細計畫後，詢問使用者確認：「**這符合您的期望嗎？請回覆「是」或提供需要更改的意見。**」
    -   **暫停**並等待使用者的回覆。在沒有明確的「是」或確認之前不要繼續。

6.  **創建檢查點提交**：
    -   暫存所有變更。如果此步驟沒有發生變更，則執行空提交。
    -   執行提交，並帶有清晰簡潔的訊息（例如 `conductor(checkpoint): Checkpoint end of Phase X`）。

7.  **使用 Git Notes 附加可稽核的驗證報告**：
    -   **步驟 8.1：草擬註釋內容**：創建詳細的驗證報告，包括自動化測試命令、手動驗證步驟和使用者的確認。
    -   **步驟 8.2：附加註釋**：使用 `git notes` 命令和上一步的完整提交哈希值將完整報告附加到檢查點提交。

8.  **獲取並記錄階段檢查點 SHA**：
    -   **步驟 7.1：獲取提交哈希**：獲取**剛創建的檢查點提交**的哈希值 (`git log -1 --format="%H"`)。
    -   **步驟 7.2：更新計畫**：讀取 `plan.md`，找到已完成階段的標題，並以 `[checkpoint: <sha>]` 格式附加提交哈希值的前 7 個字元。
    -   **步驟 7.3：寫入計畫**：將更新後的內容寫回 `plan.md`。

9. **提交計畫更新**：
    -   **操作**：暫存已修改的 `plan.md` 檔案。
    -   **操作**：使用遵循格式 `conductor(plan): Mark phase '<PHASE NAME>' as complete` 的描述性訊息提交此變更。

10. **宣布完成**：通知使用者階段已完成，並且檢查點已創建，詳細驗證報告已附加為 git 註釋。

### 品質門檻

在標記任何任務完成之前，請驗證：

-   [ ] 所有測試通過
-   [ ] 程式碼覆蓋率符合要求 (>80%)
-   [ ] 程式碼遵循專案的程式碼風格指南（如 `code_styleguides/` 中定義）
-   [ ] 所有公共函式/方法都已記錄（例如 docstrings、JSDoc、GoDoc）
-   [ ] 強制型別安全（例如型別提示、TypeScript 型別、Go 型別）
-   [ ] 沒有 linting 或靜態分析錯誤（使用專案配置的工具）
-   [ ] 在移動設備上正常工作（如果適用）
-   [ ] 文件已更新（如果需要）
-   [ ] 沒有引入安全漏洞

## 開發命令

**AI 代理指令：本節應根據專案的特定語言、框架和建構工具進行調整。**

### 設定
```bash
# 範例：設定開發環境的命令（例如安裝依賴項、配置資料庫）
# 例如，對於 Node.js 專案：npm install
# 例如，對於 Go 專案：go mod tidy
```

### 日常開發
```bash
# 範例：日常常見任務的命令（例如啟動開發伺服器、運行測試、lint、格式化）
# 例如，對於 Node.js 專案：npm run dev, npm test, npm run lint
# 例如，對於 Go 專案：go run main.go, go test ./..., go fmt ./...
```

### 提交前
```bash
# 範例：運行所有預提交檢查的命令（例如格式化、lint、型別檢查、運行測試）
# 例如，對於 Node.js 專案：npm run check
# 例如，對於 Go 專案：make check (如果存在 Makefile)
```

## 測試要求

### 單元測試
-   每個模組都必須有相應的測試。
-   使用適當的測試設定/拆卸機制（例如 fixtures、beforeEach/afterEach）。
-   模擬外部依賴項。
-   測試成功和失敗情況。

### 整合測試
-   測試完整的使用者流程。
-   驗證資料庫事務。
-   測試身份驗證和授權。
-   檢查表單提交。

### 行動測試
-   盡可能在實際 iPhone 上測試。
-   使用 Safari 開發者工具。
-   測試觸控互動。
-   驗證響應式佈局。
-   檢查 3G/4G 上的性能。

## 程式碼審查流程

### 自我審查清單
在請求審查之前：

1.  **功能性**
    -   功能按規範工作。
    -   處理邊緣情況。
    -   錯誤訊息對使用者友好。

2.  **程式碼品質**
    -   遵循風格指南。
    -   應用 DRY 原則。
    -   清晰的變數/函式名稱。
    -   適當的註釋。

3.  **測試**
    -   單元測試全面。
    -   整合測試通過。
    -   覆蓋率足夠 (>80%)。

4.  **安全性**
    -   沒有硬編碼的秘密。
    -   存在輸入驗證。
    -   防止 SQL 注入。
    -   XSS 保護到位。

5.  **性能**
    -   資料庫查詢優化。
    -   影像優化。
    -   在需要時實作快取。

6.  **行動體驗**
    -   觸摸目標足夠（44x44px）。
    -   文字無需縮放即可閱讀。
    -   在移動設備上性能可接受。
    -   互動感覺原生。

## 提交指南

### 訊息格式
```
<type>(<scope>): <description>

[optional body]

[optional footer]
```

### 類型
-   `feat`：新功能。
-   `fix`：錯誤修正。
-   `docs`：僅文件。
-   `style`：格式化，缺少分號等。
-   `refactor`：既不修正錯誤也不添加功能的程式碼變更。
-   `test`：添加缺少的測試。
-   `chore`：維護任務。

### 範例
```bash
git commit -m "feat(auth): 添加記住我功能"
git commit -m "fix(posts): 修正短文章的摘錄生成"
git commit -m "test(comments): 添加表情符號反應限制的測試"
git commit -m "style(mobile): 改善按鈕觸摸目標"
```

## 完成定義

當任務滿足以下條件時才算完成：

1.  所有程式碼都按規範實作。
2.  單元測試已編寫並通過。
3.  程式碼覆蓋率符合專案要求。
4.  文件完整（如果適用）。
5.  程式碼通過所有配置的 linting 和靜態分析檢查。
6.  在移動設備上運行良好（如果適用）。
7.  實作註釋已添加到 `plan.md`。
8.  變更已使用適當的訊息提交。
9.  Git 註釋已附加任務摘要到提交。

## 緊急程序

### 生產環境中的關鍵錯誤
1.  從主分支創建熱修復分支。
2.  為錯誤編寫失敗測試。
3.  實作最小修正。
4.  徹底測試，包括移動設備。
5.  立即部署。
6.  在 `plan.md` 中記錄。

### 資料遺失
1.  停止所有寫入操作。
2.  從最新備份恢復。
3.  驗證資料完整性。
4.  記錄事件。
5.  更新備份程序。

### 安全漏洞
1.  立即輪換所有秘密。
2.  審查存取日誌。
3.  修補漏洞。
4.  通知受影響的使用者（如果有的話）。
5.  記錄並更新安全程序。

## 部署工作流程

### 部署前清單
-   [ ] 所有測試通過。
-   [ ] 覆蓋率 >80%。
-   [ ] 沒有 linting 錯誤。
-   [ ] 移動測試完成。
-   [ ] 環境變數已配置。
-   [ ] 資料庫遷移已準備好。
-   [ ] 已創建備份。

### 部署步驟
1.  將功能分支合併到主分支。
2.  用版本標記發布。
3.  推送到部署服務。
4.  運行資料庫遷移。
5.  驗證部署。
6.  測試關鍵路徑。
7.  監控錯誤。

### 部署後
1.  監控分析。
2.  檢查錯誤日誌。
3.  收集使用者回饋。
4.  規劃下一次迭代。

## 持續改進

-   每週審查工作流程。
-   根據痛點更新。
-   記錄學到的教訓。
-   優化使用者滿意度。
-   保持簡單和可維護性。