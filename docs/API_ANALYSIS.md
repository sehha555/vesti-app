# Vesti 後端 API 技術完整度分析報告

本報告旨在全面掃描和分析 Vesti 專案的後端 API 技術現狀，涵蓋已實現的端點、資料模型、技術棧、功能覆蓋率、程式碼品質，並提出關鍵缺失項目和改進建議。

## 1. 已實作的 API 端點列表

API 路由主要遵循 Next.js App Router 結構，同時存在部分舊版或模擬的端點。

| 檔案路徑 | HTTP 方法 | 功能描述 | 狀態 |
| :--- | :--- | :--- | :--- |
| `apps/web/app/api/wardrobe/upload/route.ts` | `POST` | 上傳衣物圖片，移除背景，存到 Cloudinary，並在 Supabase 中創建衣物項目。 | **已實作** |
| `apps/web/app/api/wardrobe/items/route.ts` | `GET`, `POST` | 獲取指定用戶的所有衣物；創建新衣物項目。直接操作 Supabase。 | **已實作** |
| `apps/web/app/api/wardrobe/items/[id]/route.ts`| `GET`, `PUT`, `DELETE` | 根據 ID 獲取、更新或刪除單一衣物項目。直接操作 Supabase。 | **已實作** |
| `apps/web/app/api/outfits/route.ts` | `GET`, `POST` | 獲取所有穿搭（可依標籤、季節、場合過濾）或創建新穿搭。 | **模擬 (In-memory)** |
| `apps/web/app/api/outfits/[id]/route.ts` | `GET`, `PUT`, `DELETE` | 根據 ID 獲取、更新或刪除單一穿搭。 | **模擬 (In-memory)** |
| `apps/web/app/api/daily-outfits/route.ts` | `GET` | 根據用戶、地點（天氣）和場合生成每日穿搭推薦。 | **部分實作 (串接服務)** |
| `apps/web/app/api/reco/closet-gap-fill/route.ts`| `GET` | 推薦購買商品以「填補」用戶衣櫃的空缺。 | **模擬 (Mock Data)** |
| `apps/web/app/api/reco/basket-mixmatch/route.ts`| `GET` | 為購物籃中的商品提供穿搭推薦。 | **模擬 (Mock Data)** |
| `apps/web/app/api/reco/daily-outfits/save/route.ts`| `POST` | 保存每日穿搭推薦。 | **模擬 (Mock Data)** |
| `apps/web/app/api/reco/basket-mixmatch/save/route.ts`| `POST` | 保存購物籃混搭的穿搭。 | **模擬 (Mock Data)** |
| `services/cart-payments/index.ts` | `GET`, `POST`, `DELETE` | (舊版) 管理購物車（獲取、新增、刪除商品）並處理結帳。 | **模擬 (In-memory)** |
| `services/tryon/index.ts` | `GET`, `POST` | (舊版) 虛擬試穿的佔位符，目前功能已停用。 | **未實作 (已停用)** |
| `apps/web/app/api/test-cloudinary/route.ts` | `GET` | 測試與 Cloudinary 服務的連線。 | **測試/工具** |

## 2. 核心資料模型定義

專案的資料模型統一集中在 `packages/types/src/` 目錄下，結構清晰，完整度高。

| 資料結構 | 定義檔案 | 描述 | 完整度 |
| :--- | :--- | :--- | :--- |
| **`WardrobeItem`** | `wardrobe.ts` | 代表用戶虛擬衣櫃中的單件衣物。 | **高**。模型非常詳細，包含 AI 識別屬性、用戶自訂標籤、來源等。同時也定義了 DTO。 |
| **`Outfit`** | `outfit.ts` | 代表一套完整的穿搭組合。 | **高**。模型完整，包含組合內的物品 ID、分類標籤、評分以及來源。同樣定義了 DTO。 |
| **`CatalogItem`** | `gap.ts` | 代表可供購買的商品，即 `Product` 的對應模型。 | **中等**。對於推薦功能足夠，但若要擴展為電商功能，需增加尺寸、庫存等細節。 |
| **`Cart` / `CartItem`** | `cart.ts` | 用戶購物車的資料模型。 | **中等**。足以滿足基本購物車需求，但缺少尺寸、顏色等購物細節。 |
| **`UserEvent`** | `reco.ts` | 用於追蹤用戶行為的通用事件模型。 | **高**。設計靈活，足以應對各種用戶行為追蹤。 |

## 3. 技術棧評估

技術棧以 Next.js 和 Supabase 為核心，但在認證和錯誤處理方面存在弱點。

| 組件 | 技術/工具 | 狀態與分析 |
| :--- | :--- | :--- |
| **API 框架** | **Next.js API Routes** | 主要使用 Next.js 13+ 的 App Router。部分舊 API 採用 Pages Router 風格。 |
| **資料庫 ORM** | **Supabase Client** | **沒有使用**傳統 ORM。所有資料庫操作通過 `supabase-js` 客戶端庫進行。 |
| **資料驗證** | **Zod** | Zod 是專案主要的資料驗證工具。 |
| **認證機制** | **Supabase Auth** | 依賴 `@supabase/ssr` 和 `@supabase/supabase-js`。**存在安全隱患**，API 未做伺服器端會話驗證。 |
| **錯誤處理** | **`try...catch`** | 大多數端點使用 `try...catch`，但**缺乏統一**的錯誤處理中間件。 |

## 4. API 功能覆蓋率

核心的虛擬衣櫃功能完成度最高，AI 推薦和購物功能則處於原型階段。

| 功能模組 | 功能項目 | 狀態 | 備註 |
| :--- | :--- | :--- | :--- |
| **AI 穿搭推薦** | 每日穿搭 | **部分實作** | 依賴模擬的天氣數據。 |
| | 穿搭生成 | **部分實作** | 返回的是模擬數據。 |
| | 推薦補足 | **部分實作** | 完全返回模擬數據。 |
| **虛擬衣櫃** | 上傳 | **已實作** | 功能完整。 |
| | 衣物 CRUD | **已實作** | 已完整對接 Supabase。 |
| | 季節收納 | **已實作** | 資料模型支援。 |
| | 自訂分類 | **已實作** | 資料模型支援。 |
| **購物功能** | 商品列表 | **未實作** | 缺少公開的商品列表 API。 |
| | 購物車 | **部分實作** | 使用 In-memory Mock 數據。 |
| | 支付系統 | **部分實作** | 對接的是模擬的支付處理器。 |
| **虛擬試穿** | 虛擬試穿 | **未實作** | 功能被明確停用。 |

#### 完成度統計
- **已實作**: ~36%
- **部分實作**: ~45%
- **未實作**: ~18%
- **總體完成度**: **~59%** (*計算方式: `(已實作 + 部分實作 * 0.5) / 總數`*)

## 5. 程式碼品質檢查

程式碼品質基礎紮實，但在測試和一致性方面有待加強。

| 品質指標 | 評估結果 | 分析 |
| :--- | :--- | :--- |
| **測試檔案數量** | **15 個** | 所有測試都位於 `services` 目錄，API 路由層和前端缺乏測試。 |
| **TypeScript 型別標註** | **約 95% (高)** | 型別覆蓋率非常高，程式碼健壯性好。 |
| **錯誤處理覆蓋率** | **約 90% (中等)** | 大多數端點有基本的錯誤處理，但缺乏統一機制。 |
| **註解覆蓋率** | **中等** | 品質很高但分佈不均。部分 API 有 Swagger 註解，但未全面覆蓋。 |

## 6. 關鍵缺失項目與優先級建議

### 關鍵缺失項目
1.  **API 伺服器端認證**：存在嚴重安全漏洞，未在伺服器端驗證用戶會話。
2.  **資料庫結構 (Schema) 的版本控制**：缺乏 `schema.sql` 或 `schema.prisma` 等檔案，不利於遷移和協作。
3.  **API 層的測試覆蓋**：所有 API 路由缺乏自動化測試。
4.  **不完整的核心功能實作**：AI 和購物功能多為 Mock 數據。
5.  **缺乏統一的 API 錯誤處理機制**：錯誤處理邏輯不一致。

### 優先級建議

| 優先級 | 建議項目 | 說明與理由 |
| :--- | :--- | :--- |
| **1 (最高)** | **實作伺服器端 API 認證** | **(安全性)** 立即重構所有 API，使用 `@supabase/ssr` 從伺服器端的 cookie 中驗證和獲取用戶會話，防止數據洩露。 |
| **2 (高)** | **引入資料庫遷移工具** | **(穩定性)** 添加資料庫結構的版本控制，推薦使用 Supabase 官方的遷移工具或引入 Prisma。 |
| **3 (中)** | **為 API 路由編寫測試** | **(品質)** 為關鍵 API 編寫整合測試，確保端點行為符合預期。 |
| **4 (中)** | **完成核心功能的後端邏輯** | **(功能性)** 逐步替換 AI 推薦和購物功能中的模擬數據，實現真正的業務邏輯。 |
| **5 (低)** | **建立統一的錯誤處理和 API 文件** | **(可維護性)** 建立標準化的錯誤處理機制，並推廣 Swagger 註解以自動生成 API 文檔。 |
